<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة درجات الطلاب - إعدادية المجر الكبير للبنين</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- إضافة Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* كل الأنماط تبقى كما هي */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        :root {
            --primary-color: #4169E1;
            --secondary-color: #98FB98;
            --accent-color: #FFD700;
            --background-color: #F5F5DC;
            --text-color: #333333;
            --light-gray: #f8f9fa;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --red-grade: #ffebee;
            --green-grade: #e8f5e9;
            --white-grade: #ffffff;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --notification-color: #ff6b6b;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* شاشة تسجيل الدخول */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), #2a4cb3);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .login-container {
            background-color: var(--white);
            padding: 40px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .login-logo {
            margin-bottom: 30px;
        }

        .login-logo i {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .login-logo h1 {
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .login-logo p {
            color: #666;
            font-size: 0.9rem;
        }

        .login-form {
            margin-top: 30px;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            text-align: center;
            transition: all 0.3s;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(65, 105, 225, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }

        .login-btn:hover {
            background-color: #2a4cb3;
            transform: translateY(-3px);
        }

        .login-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #666;
        }

        /* شريط حالة الاتصال */
        .connection-status {
            background-color: var(--white);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online {
            background-color: var(--success-color);
            animation: pulse 2s infinite;
        }

        .status-offline {
            background-color: var(--danger-color);
        }

        .status-syncing {
            background-color: var(--warning-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* رأس الصفحة */
        header {
            background: linear-gradient(135deg, var(--primary-color), #2a4cb3);
            color: white;
            padding: 25px 0;
            border-radius: 0 0 20px 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo i {
            font-size: 2.5rem;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 50%;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .logo p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .user-info:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-mode-header-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .mobile-mode-header-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        /* أيقونة الإشعارات للمدير */
        .notifications-header-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            position: relative;
        }

        .notifications-header-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--notification-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .developer-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        /* شريط البحث */
        .search-container {
            background-color: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
            padding: 18px 25px 18px 60px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            font-size: 1.1rem;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(65, 105, 225, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary-color);
            font-size: 1.3rem;
        }

        .search-results {
            background-color: var(--white);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: background-color 0.2s;
        }

        .search-result-item:hover {
            background-color: #f5f9ff;
        }

        .search-result-item i {
            color: var(--primary-color);
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #888;
        }

        /* بطاقات الإحصائيات */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--white);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }

        .stat-icon-1 {
            background: linear-gradient(135deg, #4169E1, #2a4cb3);
        }

        .stat-icon-2 {
            background: linear-gradient(135deg, #98FB98, #7cd67c);
        }

        .stat-icon-3 {
            background: linear-gradient(135deg, #FFD700, #e6c200);
        }

        .stat-icon-4 {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
        }

        .stat-info h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: #666;
        }

        /* أزرار التحكم */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2a4cb3;
            transform: translateY(-3px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: #333;
        }

        .btn-secondary:hover {
            background-color: #7cd67c;
            transform: translateY(-3px);
        }

        .btn-accent {
            background-color: var(--accent-color);
            color: #333;
        }

        .btn-accent:hover {
            background-color: #e6c200;
            transform: translateY(-3px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            transform: translateY(-3px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
            transform: translateY(-3px);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .btn-warning:hover {
            background-color: #e0a800;
            transform: translateY(-3px);
        }

        .btn-info {
            background-color: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-3px);
        }

        .btn-notification {
            background-color: var(--notification-color);
            color: white;
        }

        .btn-notification:hover {
            background-color: #ee5a5a;
            transform: translateY(-3px);
        }

        /* قسم عرض الطلاب */
        .students-section {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .section-header h2 {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .class-filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .students-table {
            width: 100%;
            border-collapse: collapse;
        }

        .students-table th {
            background-color: #f8f9fa;
            padding: 18px 15px;
            text-align: right;
            color: var(--primary-color);
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
        }

        .students-table td {
            padding: 18px 15px;
            border-bottom: 1px solid #eee;
        }

        .students-table tr:hover {
            background-color: #f9fbfe;
        }

        .class-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .class-4 {
            background-color: #e6f7ff;
            color: #0066cc;
        }

        .class-5 {
            background-color: #f0ffe6;
            color: #339900;
        }

        .class-6 {
            background-color: #fff5e6;
            color: #cc6600;
        }

        /* قسم عرض درجات الطالب */
        .grades-section {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .student-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .student-details h3 {
            font-size: 1.6rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .student-details p {
            color: #666;
            margin-bottom: 3px;
        }

        .student-actions {
            display: flex;
            gap: 10px;
        }

        .student-actions button {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .print-btn {
            background-color: var(--accent-color);
            color: #333;
        }

        .save-btn {
            background-color: #28a745;
            color: white;
        }

        .close-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .grades-tables {
            overflow-x: auto;
        }

        .grades-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            min-width: 800px;
        }

        .grades-table th {
            background-color: #f0f7ff;
            padding: 18px 15px;
            text-align: center;
            color: var(--primary-color);
            font-weight: 600;
            border: 1px solid #ddd;
        }

        .grades-table td {
            padding: 15px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .grades-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .subject-header {
            background-color: #e6f0ff !important;
            font-weight: 700;
        }

        .term-header {
            background-color: #f0f7ff !important;
            font-weight: 700;
        }

        .grade-input {
            width: 70px;
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 600;
        }

        .grade-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(65, 105, 225, 0.2);
        }

        .grade-value {
            font-weight: 600;
            font-size: 1.1rem;
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
            min-width: 50px;
        }

        /* تلوين الدرجات */
        .grade-excellent {
            background-color: var(--green-grade);
            color: #2e7d32;
        }

        .grade-average {
            background-color: var(--white-grade);
            color: #333;
            border: 1px solid #ddd;
        }

        .grade-fail {
            background-color: var(--red-grade);
            color: #c62828;
        }

        /* قسم إضافة طالب جديد */
        .add-student-section {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(65, 105, 225, 0.2);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }

        /* قسم استيراد أسماء دفعة واحدة */
        .bulk-import-section {
            background-color: var(--white);
            border-radius: 15px;
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
            display: none;
        }

        .instructions {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-right: 4px solid var(--primary-color);
        }

        .instructions h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .instructions ul {
            margin-right: 20px;
            margin-bottom: 10px;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        .textarea-container {
            position: relative;
            margin-bottom: 20px;
        }

        .names-counter {
            position: absolute;
            left: 15px;
            bottom: 15px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #666;
        }

        .preview-names {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .preview-names h4 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .preview-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .preview-item {
            background-color: white;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }

        /* إشعارات التطبيق */
        .app-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.5s ease;
            max-width: 400px;
        }

        .app-notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification-success {
            background-color: var(--success-color);
            color: white;
        }

        .notification-error {
            background-color: var(--danger-color);
            color: white;
        }

        .notification-warning {
            background-color: var(--warning-color);
            color: #333;
        }

        .notification-info {
            background-color: var(--info-color);
            color: white;
        }

        .notification-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .notification-teacher {
            background-color: #6c5ce7;
            color: white;
        }

        /* نافذة تأكيد مخصصة */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .confirm-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .confirm-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .confirm-content h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .confirm-content p {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.6;
            font-size: 1.1rem;
        }

        .confirm-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* نافذة تأكيد الحذف */
        .delete-confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .delete-confirm-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .delete-confirm-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .delete-confirm-content h3 {
            color: var(--danger-color);
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        .delete-confirm-content p {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.6;
        }

        .delete-confirm-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* نافذة النسخ الاحتياطي */
        .backup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .backup-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .backup-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .backup-content h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
            text-align: center;
        }

        .backup-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .backup-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .backup-option:hover {
            border-color: var(--primary-color);
            background-color: #f5f9ff;
        }

        .backup-option i {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .backup-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* نافذة تأكيد حذف الكل */
        .delete-all-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .delete-all-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .delete-all-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .delete-all-content h3 {
            color: var(--danger-color);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .delete-all-content p {
            margin-bottom: 15px;
            color: #555;
            line-height: 1.6;
        }

        .delete-all-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }

        /* نافذة إدارة الأكواد */
        .manage-codes-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .manage-codes-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .manage-codes-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .manage-codes-content h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .current-codes-list {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
        }

        .code-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .code-item:last-child {
            border-bottom: none;
        }

        .subject-name {
            font-weight: 600;
            color: #333;
            min-width: 150px;
        }

        .code-value {
            font-family: monospace;
            font-size: 1.1rem;
            background-color: white;
            padding: 5px 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            min-width: 120px;
            text-align: center;
        }

        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .copy-btn:hover {
            background-color: #2a4cb3;
        }

        .change-code-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .change-code-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .code-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .code-input-group select,
        .code-input-group input {
            flex: 1;
        }

        .code-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 25px;
        }

        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        /* قائمة الانتظار للمزامنة */
        .pending-sync-list {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--white);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 300px;
            z-index: 999;
            display: none;
        }

        .pending-sync-list.show {
            display: block;
        }

        .pending-sync-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .pending-sync-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }

        /* مؤشر استخدام التخزين المحلي */
        .storage-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background-color: var(--white);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-size: 0.8rem;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .storage-icon {
            color: var(--primary-color);
        }

        /* نافذة الإشعارات والتغييرات */
        .notifications-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .notifications-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .notifications-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .notifications-content h3 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.5rem;
            text-align: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .notifications-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .notification-item:hover {
            background-color: #e9ecef;
        }

        .notification-item.unread {
            background-color: #e3f2fd;
            border-right: 4px solid var(--primary-color);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-subject {
            font-weight: bold;
            color: var(--primary-color);
            background-color: rgba(65, 105, 225, 0.1);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: #666;
        }

        .notification-teacher {
            color: #6c5ce7;
            font-weight: 600;
        }

        .notification-student {
            color: #2d3436;
            font-weight: 600;
        }

        .notification-details {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid #ddd;
            display: none;
        }

        .notification-details.show {
            display: block;
        }

        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .mark-read-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-notification-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .notification-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* تذييل الصفحة */
        footer {
            text-align: center;
            padding: 25px 0;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 30px;
        }

        .footer-info {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        /* شاشة تحميل Firebase */
        .firebase-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* درجات للقراءة فقط */
        .readonly-grade {
            background-color: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            cursor: not-allowed;
        }

        /* وضع الموبايل */
        .mobile-mode-enabled {
            --primary-color: #4169E1;
            --background-color: #f0f2f5;
        }

        .mobile-mode-enabled .container {
            max-width: 100%;
            padding: 10px;
        }

        .mobile-mode-enabled header {
            padding: 15px 0;
            border-radius: 0;
            margin-bottom: 15px;
        }

        .mobile-mode-enabled .header-content {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .mobile-mode-enabled .user-info {
            width: 100%;
            justify-content: center;
        }

        .mobile-mode-enabled .connection-status {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            padding: 15px;
        }

        .mobile-mode-enabled .stats-cards {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .mobile-mode-enabled .controls {
            flex-direction: column;
            gap: 10px;
        }

        .mobile-mode-enabled .btn {
            width: 100%;
            justify-content: center;
            padding: 12px;
        }

        .mobile-mode-enabled .search-container,
        .mobile-mode-enabled .students-section,
        .mobile-mode-enabled .grades-section,
        .mobile-mode-enabled .add-student-section,
        .mobile-mode-enabled .bulk-import-section {
            padding: 15px;
            margin-bottom: 15px;
        }

        .mobile-mode-enabled .students-table {
            font-size: 0.9rem;
        }

        .mobile-mode-enabled .students-table th,
        .mobile-mode-enabled .students-table td {
            padding: 10px 5px;
        }

        .mobile-mode-enabled .grades-table {
            min-width: 100%;
            font-size: 0.85rem;
        }

        .mobile-mode-enabled .grade-input {
            width: 50px;
            padding: 5px;
        }

        .mobile-mode-enabled .student-info {
            flex-direction: column;
            gap: 15px;
            text-align: center;
        }

        .mobile-mode-enabled .student-actions {
            flex-direction: column;
            width: 100%;
        }

        .mobile-mode-enabled .student-actions button {
            width: 100%;
        }

        .mobile-mode-enabled .form-row {
            grid-template-columns: 1fr;
        }

        .mobile-mode-enabled .class-filters {
            flex-direction: column;
        }

        .mobile-mode-enabled .app-notification {
            left: 10px;
            right: 10px;
            max-width: calc(100% - 20px);
            top: 10px;
        }

        .mobile-mode-enabled .confirm-modal .confirm-content,
        .mobile-mode-enabled .delete-confirm-modal .delete-confirm-content,
        .mobile-mode-enabled .backup-modal .backup-content,
        .mobile-mode-enabled .delete-all-modal .delete-all-content,
        .mobile-mode-enabled .manage-codes-modal .manage-codes-content,
        .mobile-mode-enabled .notifications-modal .notifications-content {
            width: 95%;
            padding: 20px;
        }

        .mobile-mode-enabled .pending-sync-list,
        .mobile-mode-enabled .storage-status {
            left: 10px;
            right: 10px;
            max-width: calc(100% - 20px);
            bottom: 60px;
        }

        .mobile-mode-enabled .notifications-filters {
            flex-direction: column;
        }

        /* أنماط للجوال (الإصدار القديم) */
        @media (max-width: 768px) {
            .login-container {
                padding: 20px;
                width: 95%;
            }
            
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .developer-info {
                position: relative;
                top: 0;
                left: 0;
                margin-top: 10px;
                width: 100%;
                text-align: center;
            }
            
            .connection-status {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .student-info {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .controls {
                justify-content: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .footer-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .delete-confirm-content, .backup-content, .delete-all-content,
            .confirm-content, .manage-codes-content, .notifications-content {
                width: 95%;
                padding: 20px;
            }
            
            .code-item {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .code-input-group {
                flex-direction: column;
            }
            
            .app-notification {
                left: 20px;
                right: 20px;
                max-width: calc(100% - 40px);
            }
            
            .pending-sync-list, .storage-status {
                left: 20px;
                right: 20px;
                max-width: calc(100% - 40px);
                bottom: 70px;
            }
            
            .class-filters {
                flex-direction: column;
            }
            
            .notifications-filters {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div class="login-screen" id="loginScreen">
        <div class="login-container">
            <div class="login-logo">
                <i class="fas fa-graduation-cap"></i>
                <h1>نظام إدارة درجات الطلاب</h1>
                <p>إعدادية المجر الكبير للبنين</p>
            </div>
            
            <div class="login-form">
                <input type="text" class="login-input" id="loginCode" placeholder="أدخل كود الدخول" autocomplete="off">
                <button class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> دخول إلى النظام
                </button>
            </div>
            
            <div class="login-info">
                <p><i class="fas fa-info-circle"></i> أدخل كود المادة للدخول كمدرس، أو كود المدير للصلاحيات الكاملة</p>
                <p style="margin-top: 10px; font-size: 0.8rem; color: #888;">
                    كود المدير: ADMIN1234 (للتجربة فقط)
                </p>
            </div>
        </div>
    </div>

    <!-- شاشة تحميل Firebase -->
    <div class="firebase-loading" id="firebaseLoading">
        <div class="spinner"></div>
        <h3>جاري التحميل...</h3>
        <p>جاري تحميل البيانات</p>
    </div>

    <!-- شريط حالة الاتصال والمزامنة -->
    <div class="container" id="mainApp" style="display: none;">
        <div class="connection-status" id="connectionStatus">
            <div class="status-item">
                <span class="status-indicator status-offline" id="connectionIndicator"></span>
                <span id="connectionText">جاري الاتصال...</span>
            </div>
            <div class="status-item">
                <i class="fas fa-sync"></i>
                <span id="syncText">لم يتم المزامنة بعد</span>
            </div>
            <div class="status-item">
                <i class="fas fa-clock"></i>
                <span id="lastSyncText">آخر مزامنة: --/--/---- --:--</span>
            </div>
            <div class="status-item" id="userRoleInfo">
                <i class="fas fa-user-tag"></i>
                <span id="userRoleText">جاري التحميل...</span>
            </div>
        </div>
    </div>

    <!-- رأس الصفحة -->
    <header id="mainHeader" style="display: none;">
        <div class="container">
            <div class="developer-info">
                <i class="fas fa-code"></i>
                <span>حقوق البرنامج © 2023 - مطور البرنامج: الاستاذ محمد عبد الزهره</span>
            </div>
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-graduation-cap"></i>
                    <div>
                        <h1>نظام إدارة درجات الطلاب</h1>
                        <p>إعدادية المجر الكبير للبنين - الصفوف العلمية (الرابع، الخامس، السادس)</p>
                    </div>
                </div>
                <div class="header-controls">
                    <button class="mobile-mode-header-btn" id="mobileModeHeaderBtn">
                        <i class="fas fa-mobile-alt"></i> وضع الموبايل
                    </button>
                    <!-- زر الإشعارات للمدير فقط -->
                    <button class="notifications-header-btn" id="notificationsHeaderBtn" style="display: none;">
                        <i class="fas fa-bell"></i> الإشعارات
                        <span class="notification-badge" id="notificationBadge">0</span>
                    </button>
                    <div class="user-info">
                        <i class="fas fa-user-tie"></i>
                        <div>
                            <p id="currentUserRole">مدير المدرسة</p>
                            <p id="currentUserName">د.مازن عبد الزهرة رزيج</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- المحتوى الرئيسي -->
    <div class="container" id="mainContent" style="display: none;">
        <!-- شريط البحث -->
        <div class="search-container">
            <h2 style="margin-bottom: 20px; color: var(--primary-color);">البحث عن طالب</h2>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ابحث عن طالب بالاسم أو الشعبة...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="search-results" id="searchResults">
                <!-- سيتم ملء نتائج البحث هنا ديناميكيًا -->
            </div>
        </div>

        <!-- بطاقات الإحصائيات -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon stat-icon-1">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalStudents">0</h3>
                    <p>إجمالي الطلاب</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-icon-2">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <div class="stat-info">
                    <h3 id="totalClasses">3</h3>
                    <p>عدد الصفوف</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-icon-3">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-info">
                    <h3 id="gradeChanges">0</h3>
                    <p>التغييرات اليوم</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon stat-icon-4">
                    <i class="fas fa-bell"></i>
                </div>
                <div class="stat-info">
                    <h3 id="unreadNotifications">0</h3>
                    <p>إشعارات جديدة</p>
                </div>
            </div>
        </div>

        <!-- أزرار التحكم -->
        <div class="controls">
            <button class="btn btn-primary" id="showAllStudents">
                <i class="fas fa-list"></i> عرض جميع الطلاب
            </button>
            <button class="btn btn-secondary" id="addStudentBtn">
                <i class="fas fa-user-plus"></i> إضافة طالب جديد
            </button>
            <button class="btn btn-info" id="bulkImportBtn">
                <i class="fas fa-file-import"></i> استيراد أسماء دفعة واحدة
            </button>
            <button class="btn btn-info" id="uploadToServerBtn">
                <i class="fas fa-cloud-upload-alt"></i> رفع البيانات إلى السيرفر
            </button>
            <button class="btn btn-info" id="downloadFromServerBtn">
                <i class="fas fa-cloud-download-alt"></i> استيراد البيانات من السيرفر
            </button>
            <button class="btn btn-success" id="backupBtn">
                <i class="fas fa-database"></i> النسخ الاحتياطي
            </button>
            <button class="btn btn-danger" id="deleteAllBtn">
                <i class="fas fa-trash-alt"></i> حذف كافة البيانات
            </button>
            <button class="btn btn-warning" id="manageCodesBtn" style="display: none;">
                <i class="fas fa-key"></i> إدارة أكواد المدرسين
            </button>
            <button class="btn btn-notification" id="viewNotificationsBtn" style="display: none;">
                <i class="fas fa-history"></i> سجل التغييرات
            </button>
        </div>

        <!-- قسم عرض جميع الطلاب -->
        <section class="students-section" id="studentsSection">
            <div class="section-header">
                <h2><i class="fas fa-users"></i> قائمة الطلاب</h2>
            </div>
            
            <div class="class-filters">
                <div>
                    <label for="filterClass">اختر الصف:</label>
                    <select id="filterClass">
                        <option value="all">جميع الصفوف</option>
                        <option value="4">الصف الرابع العلمي</option>
                        <option value="5">الصف الخامس العلمي</option>
                        <option value="6">الصف السادس العلمي</option>
                    </select>
                </div>
                <div>
                    <label for="filterDivision">اختر الشعبة:</label>
                    <select id="filterDivision">
                        <option value="all">جميع الشعب</option>
                        <option value="أ">أ</option>
                        <option value="ب">ب</option>
                        <option value="ج">ج</option>
                        <option value="د">د</option>
                        <option value="ه">ه</option>
                        <option value="و">و</option>
                    </select>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="students-table">
                    <thead>
                        <tr>
                            <th>الاسم</th>
                            <th>الصف</th>
                            <th>الشعبة</th>
                            <th>رقم هاتف ولي الأمر</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="studentsTableBody">
                        <!-- سيتم ملء بيانات الطلاب هنا ديناميكيًا -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- قسم استيراد أسماء دفعة واحدة -->
        <section class="bulk-import-section" id="bulkImportSection">
            <div class="section-header">
                <h2><i class="fas fa-file-import"></i> استيراد أسماء طلاب دفعة واحدة</h2>
                <button class="btn btn-secondary" id="closeBulkImport">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
            
            <div class="instructions">
                <h4><i class="fas fa-info-circle"></i> تعليمات الاستيراد:</h4>
                <ul>
                    <li>يمكنك نسخ أسماء الطلاب من أي برنامج (Word، Excel، PDF، إلخ)</li>
                    <li>الصق الأسماء في المربع أدناه (سطر واحد لكل طالب)</li>
                    <li>اختر الصف والشعبة المناسبة للطلاب</li>
                    <li>يمكنك إضافة أرقام الهواتف لاحقاً بشكل يدوي</li>
                    <li>ستتم إضافة جميع الأسماء تلقائياً إلى قاعدة البيانات</li>
                </ul>
            </div>
            
            <form id="bulkImportForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="bulkClass">الصف</label>
                        <select id="bulkClass" required>
                            <option value="">اختر الصف</option>
                            <option value="4">الرابع العلمي</option>
                            <option value="5">الخامس العلمي</option>
                            <option value="6">السادس العلمي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="bulkDivision">الشعبة</label>
                        <select id="bulkDivision" required>
                            <option value="">اختر الشعبة</option>
                            <option value="أ">أ</option>
                            <option value="ب">ب</option>
                            <option value="ج">ج</option>
                            <option value="د">د</option>
                            <option value="ه">ه</option>
                            <option value="و">و</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="bulkNames">أسماء الطلاب (سطر واحد لكل طالب)</label>
                    <div class="textarea-container">
                        <textarea id="bulkNames" rows="10" placeholder="أدخل أسماء الطلاب هنا...&#10;مثال:&#10;محمد أحمد&#10;علي حسن&#10;أحمد محمود&#10;..."></textarea>
                        <div class="names-counter" id="namesCounter">عدد الأسماء: 0</div>
                    </div>
                </div>
                
                <div class="preview-names" id="previewNames">
                    <h4>معاينة الأسماء:</h4>
                    <div class="preview-list" id="previewList">
                        <!-- سيتم عرض معاينة الأسماء هنا -->
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="previewBulkNames">
                        <i class="fas fa-eye"></i> معاينة الأسماء
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> استيراد الأسماء
                    </button>
                </div>
            </form>
        </section>

        <!-- قسم عرض درجات الطالب -->
        <section class="grades-section" id="gradesSection">
            <div class="student-info">
                <div class="student-details">
                    <h3 id="studentName">اسم الطالب</h3>
                    <p id="studentClass">الصف: -</p>
                    <p id="studentDivision">الشعبة: -</p>
                    <p id="studentParentPhone">رقم هاتف ولي الأمر: -</p>
                </div>
                <div class="student-actions">
                    <button class="save-btn" id="saveGradesBtn">
                        <i class="fas fa-save"></i> حفظ التعديلات
                    </button>
                    <button class="print-btn" id="printGradesBtn">
                        <i class="fas fa-print"></i> طباعة الدرجات
                    </button>
                    <button class="close-btn" id="closeGradesBtn">
                        <i class="fas fa-times"></i> إغلاق
                    </button>
                </div>
            </div>
            
            <div class="grades-tables">
                <h3 style="margin-bottom: 20px; color: var(--primary-color); text-align: center;">تفاصيل درجات الطالب</h3>
                <table class="grades-table" id="gradesTable">
                    <!-- سيتم ملء جدول الدرجات هنا ديناميكيًا -->
                </table>
            </div>
        </section>

        <!-- قسم إضافة طالب جديد -->
        <section class="add-student-section" id="addStudentSection">
            <div class="section-header">
                <h2><i class="fas fa-user-plus"></i> إضافة طالب جديد</h2>
            </div>
            
            <form id="addStudentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentNameInput">اسم الطالب</label>
                        <input type="text" id="studentNameInput" required>
                    </div>
                    <div class="form-group">
                        <label for="studentClassInput">الصف</label>
                        <select id="studentClassInput" required>
                            <option value="">اختر الصف</option>
                            <option value="4">الرابع العلمي</option>
                            <option value="5">الخامس العلمي</option>
                            <option value="6">السادس العلمي</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentDivisionInput">الشعبة</label>
                        <select id="studentDivisionInput" required>
                            <option value="">اختر الشعبة</option>
                            <option value="أ">أ</option>
                            <option value="ب">ب</option>
                            <option value="ج">ج</option>
                            <option value="د">د</option>
                            <option value="ه">ه</option>
                            <option value="و">و</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="parentPhoneInput">رقم هاتف ولي الأمر</label>
                        <input type="tel" id="parentPhoneInput" placeholder="مثال: 07701234567" required>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelAddStudent">إلغاء</button>
                    <button type="submit" class="btn btn-primary">إضافة الطالب</button>
                </div>
            </form>
        </section>
    </div>

    <!-- إشعارات التطبيق -->
    <div class="app-notification notification-success" id="successNotification">
        <i class="fas fa-check-circle"></i>
        <span id="successNotificationText">تمت العملية بنجاح!</span>
    </div>

    <div class="app-notification notification-error" id="errorNotification">
        <i class="fas fa-exclamation-circle"></i>
        <span id="errorNotificationText">حدث خطأ!</span>
    </div>

    <div class="app-notification notification-warning" id="warningNotification">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="warningNotificationText">تحذير!</span>
    </div>

    <div class="app-notification notification-info" id="infoNotification">
        <i class="fas fa-info-circle"></i>
        <span id="infoNotificationText">معلومات</span>
    </div>

    <div class="app-notification notification-primary" id="syncNotification">
        <i class="fas fa-sync"></i>
        <span id="syncNotificationText">جاري المزامنة...</span>
    </div>

    <div class="app-notification notification-teacher" id="teacherNotification">
        <i class="fas fa-chalkboard-teacher"></i>
        <span id="teacherNotificationText">تغيير جديد في الدرجات</span>
    </div>

    <!-- مؤشر استخدام التخزين المحلي -->
    <div class="storage-status" id="storageStatus">
        <i class="fas fa-database storage-icon"></i>
        <span id="storageText">جاري تحميل...</span>
    </div>

    <!-- قائمة الانتظار للمزامنة -->
    <div class="pending-sync-list" id="pendingSyncList">
        <div class="pending-sync-header">
            <h4><i class="fas fa-clock"></i> عمليات في انتظار المزامنة</h4>
            <span class="pending-count" id="pendingCount">0</span>
        </div>
        <div id="pendingSyncItems">
            <!-- سيتم ملء العناصر هنا ديناميكيًا -->
        </div>
    </div>

    <!-- نافذة تأكيد مخصصة -->
    <div class="confirm-modal" id="confirmModal">
        <div class="confirm-content">
            <h3><i class="fas fa-question-circle"></i> تأكيد</h3>
            <p id="confirmMessage">هل تريد المتابعة؟</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" id="confirmCancelBtn">إلغاء</button>
                <button class="btn btn-primary" id="confirmOkBtn">موافق</button>
            </div>
        </div>
    </div>

    <!-- نافذة الإشعارات والتغييرات -->
    <div class="notifications-modal" id="notificationsModal">
        <div class="notifications-content">
            <h3><i class="fas fa-history"></i> سجل التغييرات والإشعارات</h3>
            
            <div class="notifications-filters">
                <div>
                    <label for="filterNotificationSubject">تصفية حسب المادة:</label>
                    <select id="filterNotificationSubject">
                        <option value="all">جميع المواد</option>
                        <option value="الرياضيات">الرياضيات</option>
                        <option value="اللغة العربية">اللغة العربية</option>
                        <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                        <option value="الكيمياء">الكيمياء</option>
                        <option value="الفيزياء">الفيزياء</option>
                        <option value="الأحياء">الأحياء</option>
                        <option value="الإسلامية">الإسلامية</option>
                        <option value="جرائم حزب البعث">جرائم حزب البعث</option>
                    </select>
                </div>
                <div>
                    <label for="filterNotificationTeacher">تصفية حسب المدرس:</label>
                    <select id="filterNotificationTeacher">
                        <option value="all">جميع المدرسين</option>
                        <!-- سيتم ملء المدرسين هنا ديناميكيًا -->
                    </select>
                </div>
                <div>
                    <label for="filterNotificationStatus">حالة الإشعار:</label>
                    <select id="filterNotificationStatus">
                        <option value="all">الكل</option>
                        <option value="unread">غير مقروء</option>
                        <option value="read">مقروء</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="filterNotificationsBtn">
                    <i class="fas fa-filter"></i> تطبيق
                </button>
                <button class="btn btn-secondary" id="markAllReadBtn">
                    <i class="fas fa-check-double"></i> تعيين الكل كمقروء
                </button>
            </div>
            
            <div class="notifications-list" id="notificationsList">
                <!-- سيتم ملء الإشعارات هنا ديناميكيًا -->
            </div>
            
            <div class="notification-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalNotificationsCount">0</div>
                    <div class="stat-label">إجمالي التغييرات</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="todayNotificationsCount">0</div>
                    <div class="stat-label">التغييرات اليوم</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="unreadNotificationsCount">0</div>
                    <div class="stat-label">غير مقروء</div>
                </div>
            </div>
            
            <div class="code-actions" style="margin-top: 20px;">
                <button class="btn btn-danger" id="clearAllNotificationsBtn">
                    <i class="fas fa-trash"></i> حذف جميع الإشعارات
                </button>
                <button class="btn btn-primary" id="closeNotificationsBtn">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة إدارة الأكواد -->
    <div class="manage-codes-modal" id="manageCodesModal">
        <div class="manage-codes-content">
            <h3><i class="fas fa-key"></i> إدارة أكواد المدرسين</h3>
            
            <div class="current-codes-list">
                <h4 style="color: var(--primary-color); margin-bottom: 15px;">الأكواد الحالية:</h4>
                <div id="currentCodesList">
                    <!-- سيتم ملء الأكواد هنا ديناميكيًا -->
                </div>
            </div>
            
            <div class="change-code-section">
                <h4><i class="fas fa-edit"></i> تغيير كود مادة محددة:</h4>
                <div class="code-input-group">
                    <select id="changeSubjectSelect">
                        <option value="">اختر المادة</option>
                        <option value="الرياضيات">الرياضيات</option>
                        <option value="اللغة العربية">اللغة العربية</option>
                        <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                        <option value="الكيمياء">الكيمياء</option>
                        <option value="الفيزياء">الفيزياء</option>
                        <option value="الأحياء">الأحياء</option>
                        <option value="الإسلامية">الإسلامية</option>
                        <option value="جرائم حزب البعث">جرائم حزب البعث</option>
                    </select>
                    <input type="text" id="newCodeInput" placeholder="أدخل الكود الجديد">
                </div>
                <button class="btn btn-warning" id="changeCodeBtn">
                    <i class="fas fa-sync"></i> تغيير الكود
                </button>
            </div>
            
            <div class="change-code-section">
                <h4><i class="fas fa-redo"></i> إعادة تعيين جميع الأكواد:</h4>
                <p style="color: #666; margin-bottom: 15px;">سيتم إنشاء أكواد عشوائية جديدة لجميع المواد</p>
                <button class="btn btn-danger" id="resetAllCodesBtn">
                    <i class="fas fa-redo"></i> إعادة تعيين جميع الأكواد
                </button>
            </div>
            
            <div class="code-actions">
                <button class="btn btn-secondary" id="printCodesBtn">
                    <i class="fas fa-print"></i> طباعة الأكواد
                </button>
                <button class="btn btn-primary" id="closeManageCodesBtn">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
            
            <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>ملاحظة:</strong> فقط المدير يستطيع تغيير الأكواد. بعد التغيير، يجب إعلام المدرس بالكود الجديد.
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد الحذف -->
    <div class="delete-confirm-modal" id="deleteConfirmModal">
        <div class="delete-confirm-content">
            <h3><i class="fas fa-exclamation-triangle"></i> تأكيد الحذف</h3>
            <p id="deleteConfirmText">هل أنت متأكد من رغبتك في حذف هذا الطالب؟</p>
            <p style="color: #dc3545; font-weight: bold;">هذا الإجراء لا يمكن التراجع عنه!</p>
            <div class="delete-confirm-actions">
                <button class="btn btn-secondary" id="cancelDeleteBtn">إلغاء</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">نعم، احذف الطالب</button>
            </div>
        </div>
    </div>

    <!-- نافذة النسخ الاحتياطي -->
    <div class="backup-modal" id="backupModal">
        <div class="backup-content">
            <h3><i class="fas fa-database"></i> النسخ الاحتياطي والاستعادة</h3>
            <div class="backup-options">
                <div class="backup-option" id="backupLocalOption">
                    <i class="fas fa-download"></i>
                    <div>
                        <h4>إنشاء نسخة احتياطية محلية</h4>
                        <p>حفظ جميع بيانات الطلاب والدرجات في ملف JSON على جهازك</p>
                    </div>
                </div>
                <div class="backup-option" id="restoreLocalOption">
                    <i class="fas fa-upload"></i>
                    <div>
                        <h4>استعادة من ملف محلي</h4>
                        <p>تحميل بيانات من ملف JSON واستبدال البيانات الحالية</p>
                    </div>
                </div>
                <div class="backup-option" id="exportExcelOption">
                    <i class="fas fa-file-excel"></i>
                    <div>
                        <h4>تصدير إلى Excel</h4>
                        <p>تصدير جميع البيانات إلى ملف Excel</p>
                    </div>
                </div>
            </div>
            <div class="backup-actions">
                <button class="btn btn-secondary" id="closeBackupBtn">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد حذف كافة البيانات -->
    <div class="delete-all-modal" id="deleteAllModal">
        <div class="delete-all-content">
            <h3><i class="fas fa-exclamation-triangle"></i> تأكيد حذف كافة البيانات</h3>
            <p id="deleteAllConfirmText">هل أنت متأكد من رغبتك في حذف كافة بيانات الطلاب؟</p>
            <p style="color: #dc3545; font-weight: bold;">هذا الإجراء سيمحو جميع البيانات محلياً ومن السحابة ولا يمكن التراجع عنه!</p>
            <div class="delete-all-actions">
                <button class="btn btn-secondary" id="cancelDeleteAllBtn">إلغاء</button>
                <button class="btn btn-danger" id="confirmDeleteAllBtn">نعم، احذف الكل</button>
            </div>
        </div>
    </div>

    <!-- تذييل الصفحة -->
    <footer class="container" id="mainFooter" style="display: none;">
        <p>© 2023 نظام إدارة درجات الطلاب - إعدادية المجر الكبير للبنين. جميع الحقوق محفوظة.</p>
        <div class="footer-info">
            <p>مدير المدرسة: د.مازن عبد الزهرة رزيج</p>
            <p>مطور البرنامج: الاستاذ محمد عبد الزهره</p>
        </div>
    </footer>

    <script>
        // ========== تهيئة Firebase ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD33Xxsa7XRKs9HcVvikT1Moe0Ci6lWM6w",
            authDomain: "drjat-8832a.firebaseapp.com",
            projectId: "drjat-8832a",
            storageBucket: "drjat-8832a.firebasestorage.app",
            messagingSenderId: "357907056046",
            appId: "1:357907056046:web:b1d997e16bda8b1c0b343f"
        };
        
        // تهيئة Firebase
        let db;
        let isFirebaseInitialized = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isFirebaseInitialized = true;
            console.log("تم تهيئة Firebase بنجاح!");
        } catch (err) {
            console.log("Firebase already initialized", err);
            isFirebaseInitialized = true;
        }
        
        // بيانات الطلاب
        let students = [];
        
        // حالة المزامنة
        let isSyncing = false;
        let lastSyncTime = null;
        let isOnline = false;
        
        // قائمة الانتظار للمزامنة
        let pendingSyncQueue = [];
        
        // تعديلات محلية مؤقتة
        let localChanges = new Map();
        
        // قائمة بالمواد الدراسية لكل صف
        const subjectsByClass = {
            4: ["الإسلامية", "اللغة العربية", "اللغة الإنجليزية", "الرياضيات", "الكيمياء", "الفيزياء", "الأحياء", "جرائم حزب البعث"],
            5: ["الإسلامية", "اللغة العربية", "اللغة الإنجليزية", "الرياضيات", "الكيمياء", "الفيزياء", "الأحياء"],
            6: ["الإسلامية", "اللغة العربية", "اللغة الإنجليزية", "الرياضيات", "الكيمياء", "الفيزياء", "الأحياء"]
        };
        
        // الطالب الحالي المعروض
        let currentStudentId = null;
        let studentToDeleteId = null;

        // ========== نظام الأكواد والصلاحيات ==========
        
        // كود المدير الثابت
        const ADMIN_CODE = "ADMIN1234";
        
        // الأكواد الافتراضية للمواد
        const DEFAULT_CODES = {
            admin: ADMIN_CODE,
            subjects: {
                "الرياضيات": "MATH2024",
                "اللغة العربية": "ARABIC2024",
                "اللغة الإنجليزية": "ENGL2024",
                "الكيمياء": "CHEM2024",
                "الفيزياء": "PHYS2024",
                "الأحياء": "BIO2024",
                "الإسلامية": "ISLAM2024",
                "جرائم حزب البعث": "BAATH2024"
            }
        };
        
        // المستخدم الحالي
        let currentUser = null;
        
        // مفاتيح التخزين المحلي
        const STORAGE_KEYS = {
            STUDENTS: 'students_data',
            PENDING_SYNC: 'pending_sync_queue',
            LAST_SYNC: 'last_sync_time',
            LOCAL_CHANGES: 'local_changes',
            APP_VERSION: 'app_version',
            ACCESS_CODES: 'access_codes',
            CODE_CHANGE_LOG: 'code_change_log',
            NOTIFICATIONS: 'notifications_data',
            LAST_NOTIFICATION_CHECK: 'last_notification_check'
        };
        
        // إصدار التطبيق
        const APP_VERSION = '7.1';
        
        // ========== نظام الإشعارات والتغييرات ==========
        let notifications = [];
        let unreadNotificationsCount = 0;
        let lastNotificationCheck = null;
        
        // ========== نظام التخزين المحلي الذكي ==========
        
        // حفظ البيانات محلياً
        function saveToLocalStorage() {
            try {
                // حفظ الطلاب
                localStorage.setItem(STORAGE_KEYS.STUDENTS, JSON.stringify(students));
                
                // حفظ قائمة الانتظار
                localStorage.setItem(STORAGE_KEYS.PENDING_SYNC, JSON.stringify(pendingSyncQueue));
                
                // حفظ وقت آخر مزامنة
                if (lastSyncTime) {
                    localStorage.setItem(STORAGE_KEYS.LAST_SYNC, lastSyncTime.toISOString());
                }
                
                // حفظ التعديلات المحلية
                localStorage.setItem(STORAGE_KEYS.LOCAL_CHANGES, JSON.stringify([...localChanges]));
                
                // حفظ إصدار التطبيق
                localStorage.setItem(STORAGE_KEYS.APP_VERSION, APP_VERSION);
                
                // حفظ الأكواد
                if (currentUser && currentUser.type === 'admin') {
                    localStorage.setItem(STORAGE_KEYS.ACCESS_CODES, JSON.stringify(DEFAULT_CODES));
                }
                
                // حفظ الإشعارات
                localStorage.setItem(STORAGE_KEYS.NOTIFICATIONS, JSON.stringify(notifications));
                
                // تحديث مؤشر التخزين
                updateStorageStatus();
                
                console.log("تم حفظ البيانات محلياً");
            } catch (error) {
                console.error("خطأ في حفظ البيانات محلياً:", error);
                showNotification('error', 'حدث خطأ في حفظ البيانات محلياً');
            }
        }
        
        // تحميل البيانات من التخزين المحلي
        function loadFromLocalStorage() {
            try {
                // تحميل الطلاب
                const studentsData = localStorage.getItem(STORAGE_KEYS.STUDENTS);
                if (studentsData) {
                    students = JSON.parse(studentsData);
                    console.log(`تم تحميل ${students.length} طالب من التخزين المحلي`);
                }
                
                // تحميل قائمة الانتظار
                const pendingData = localStorage.getItem(STORAGE_KEYS.PENDING_SYNC);
                if (pendingData) {
                    pendingSyncQueue = JSON.parse(pendingData);
                }
                
                // تحميل وقت آخر مزامنة
                const lastSyncData = localStorage.getItem(STORAGE_KEYS.LAST_SYNC);
                if (lastSyncData) {
                    lastSyncTime = new Date(lastSyncData);
                }
                
                // تحميل التعديلات المحلية
                const localChangesData = localStorage.getItem(STORAGE_KEYS.LOCAL_CHANGES);
                if (localChangesData) {
                    const changesArray = JSON.parse(localChangesData);
                    localChanges = new Map(changesArray);
                }
                
                // التحقق من إصدار التطبيق
                const savedVersion = localStorage.getItem(STORAGE_KEYS.APP_VERSION);
                if (!savedVersion || savedVersion !== APP_VERSION) {
                    // تحديث الإصدار
                    localStorage.setItem(STORAGE_KEYS.APP_VERSION, APP_VERSION);
                }
                
                // تحميل الإشعارات
                const notificationsData = localStorage.getItem(STORAGE_KEYS.NOTIFICATIONS);
                if (notificationsData) {
                    notifications = JSON.parse(notificationsData);
                    // حساب الإشعارات غير المقروءة
                    unreadNotificationsCount = notifications.filter(n => !n.read).length;
                }
                
                // تحميل وقت آخر فحص للإشعارات
                const lastCheckData = localStorage.getItem(STORAGE_KEYS.LAST_NOTIFICATION_CHECK);
                if (lastCheckData) {
                    lastNotificationCheck = new Date(lastCheckData);
                }
                
                // تحديث مؤشر التخزين
                updateStorageStatus();
                
                return true;
            } catch (error) {
                console.error("خطأ في تحميل البيانات من التخزين المحلي:", error);
                return false;
            }
        }
        
        // تحديث حالة التخزين
        function updateStorageStatus() {
            try {
                const storageText = document.getElementById('storageText');
                const usedSpace = JSON.stringify(localStorage).length;
                const maxSpace = 5 * 1024 * 1024; // 5MB
                const percentUsed = Math.round((usedSpace / maxSpace) * 100);
                
                let statusText = `التخزين المحلي: ${students.length} طالب`;
                
                if (pendingSyncQueue.length > 0) {
                    statusText += ` | ${pendingSyncQueue.length} في الانتظار`;
                }
                
                if (localChanges.size > 0) {
                    statusText += ` | ${localChanges.size} تعديل`;
                }
                
                if (notifications.length > 0) {
                    statusText += ` | ${notifications.length} إشعار`;
                }
                
                if (percentUsed > 80) {
                    statusText += ` | ⚠️ ${percentUsed}% ممتلئ`;
                }
                
                storageText.textContent = statusText;
            } catch (error) {
                console.error("خطأ في تحديث حالة التخزين:", error);
            }
        }
        
        // ========== نظام تسجيل الدخول بالأكواد ==========
        
        // التحقق من صحة الكود
        function verifyAccessCode(code) {
            const upperCode = code.toUpperCase();
            
            // التحقق من كود المدير
            if (upperCode === ADMIN_CODE) {
                return {
                    type: 'admin',
                    role: 'مدير النظام',
                    name: 'مدير المدرسة',
                    subject: null
                };
            }
            
            // التحقق من أكواد المدرسين
            for (const [subject, subjectCode] of Object.entries(DEFAULT_CODES.subjects)) {
                if (upperCode === subjectCode) {
                    return {
                        type: 'teacher',
                        role: `مدرس ${subject}`,
                        name: `مدرس ${subject}`,
                        subject: subject
                    };
                }
            }
            
            return null;
        }
        
        // تسجيل الدخول
        function login() {
            const code = document.getElementById('loginCode').value.trim();
            
            if (!code) {
                showNotification('error', 'يرجى إدخال كود الدخول');
                return;
            }
            
            const user = verifyAccessCode(code);
            
            if (user) {
                currentUser = user;
                
                // حفظ حالة المستخدم
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                
                // إخفاء شاشة الدخول
                document.getElementById('loginScreen').style.display = 'none';
                
                // إظهار التطبيق الرئيسي
                document.getElementById('mainApp').style.display = 'block';
                document.getElementById('mainHeader').style.display = 'block';
                document.getElementById('mainContent').style.display = 'block';
                document.getElementById('mainFooter').style.display = 'block';
                
                // تحديث معلومات المستخدم
                document.getElementById('currentUserRole').textContent = user.role;
                document.getElementById('currentUserName').textContent = user.name;
                document.getElementById('userRoleText').textContent = user.role;
                
                // التحكم في إظهار زر إدارة الأكواد والإشعارات (للمدير فقط)
                if (user.type === 'admin') {
                    document.getElementById('manageCodesBtn').style.display = 'flex';
                    document.getElementById('viewNotificationsBtn').style.display = 'flex';
                    document.getElementById('notificationsHeaderBtn').style.display = 'flex';
                    updateNotificationBadge();
                } else {
                    document.getElementById('manageCodesBtn').style.display = 'none';
                    document.getElementById('viewNotificationsBtn').style.display = 'none';
                    document.getElementById('notificationsHeaderBtn').style.display = 'none';
                }
                
                showNotification('success', `مرحباً ${user.role}`);
                
                // تحميل البيانات
                initializeApp();
            } else {
                showNotification('error', 'كود الدخول غير صحيح');
                document.getElementById('loginCode').value = '';
                document.getElementById('loginCode').focus();
            }
        }
        
        // تسجيل الخروج
        function logout() {
            showConfirm('هل تريد تسجيل الخروج؟', function() {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                
                // إظهار شاشة الدخول
                document.getElementById('loginScreen').style.display = 'flex';
                
                // إخفاء التطبيق الرئيسي
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('mainHeader').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('mainFooter').style.display = 'none';
                
                // إعادة تعيين حق الدخول
                document.getElementById('loginCode').value = '';
                document.getElementById('loginCode').focus();
            });
        }
        
        // ========== نظام التأكيد المخصص ==========
        
        let confirmCallback = null;
        let confirmMessage = '';
        
        // عرض نافذة التأكيد المخصصة
        function showConfirm(message, callback) {
            confirmMessage = message;
            confirmCallback = callback;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.add('show');
        }
        
        // إغلاق نافذة التأكيد
        function closeConfirm() {
            document.getElementById('confirmModal').classList.remove('show');
            confirmCallback = null;
        }
        
        // ========== نظام الإشعارات والتغييرات ==========
        
        // إضافة إشعار جديد
        function addNotification(teacherName, teacherSubject, studentName, action, oldValue, newValue, details) {
            const notification = {
                id: 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                teacherName: teacherName,
                teacherSubject: teacherSubject,
                studentName: studentName,
                action: action, // 'add', 'update', 'delete'
                oldValue: oldValue,
                newValue: newValue,
                details: details,
                timestamp: new Date().toISOString(),
                read: false,
                date: new Date().toLocaleDateString('ar-EG'),
                time: new Date().toLocaleTimeString('ar-EG')
            };
            
            notifications.unshift(notification); // إضافة في البداية
            unreadNotificationsCount++;
            
            // حفظ الإشعارات
            saveToLocalStorage();
            
            // تحديث العدادات
            updateNotificationBadge();
            updateNotificationsStats();
            
            // إظهار إشعار للمدير إذا كان مسجلاً
            if (currentUser && currentUser.type === 'admin') {
                showTeacherNotification(notification);
            }
            
            return notification.id;
        }
        
        // إظهار إشعار المدرس للمدير
        function showTeacherNotification(notification) {
            let actionText = '';
            switch (notification.action) {
                case 'add':
                    actionText = 'إضافة درجة جديدة';
                    break;
                case 'update':
                    actionText = 'تعديل درجة';
                    break;
                case 'delete':
                    actionText = 'حذف درجة';
                    break;
                default:
                    actionText = 'تغيير';
            }
            
            const message = `قام ${notification.teacherName} (${notification.teacherSubject}) ${actionText} للطالب ${notification.studentName}`;
            document.getElementById('teacherNotificationText').textContent = message;
            document.getElementById('teacherNotification').classList.add('show');
            
            setTimeout(() => {
                document.getElementById('teacherNotification').classList.remove('show');
            }, 5000);
        }
        
        // تحديث شارة الإشعارات
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            const unreadNotifications = document.getElementById('unreadNotifications');
            
            if (unreadNotificationsCount > 0) {
                badge.textContent = unreadNotificationsCount;
                badge.style.display = 'flex';
                if (unreadNotifications) unreadNotifications.textContent = unreadNotificationsCount;
            } else {
                badge.style.display = 'none';
                if (unreadNotifications) unreadNotifications.textContent = '0';
            }
        }
        
        // تحديث إحصائيات الإشعارات
        function updateNotificationsStats() {
            const totalNotifications = document.getElementById('totalNotificationsCount');
            const todayNotifications = document.getElementById('todayNotificationsCount');
            const unreadNotifications = document.getElementById('unreadNotificationsCount');
            const gradeChanges = document.getElementById('gradeChanges');
            
            const today = new Date().toLocaleDateString('ar-EG');
            const todayCount = notifications.filter(n => n.date === today).length;
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (totalNotifications) totalNotifications.textContent = notifications.length;
            if (todayNotifications) todayNotifications.textContent = todayCount;
            if (unreadNotifications) unreadNotifications.textContent = unreadCount;
            if (gradeChanges) gradeChanges.textContent = todayCount;
            
            unreadNotificationsCount = unreadCount;
            updateNotificationBadge();
        }
        
        // التحقق من الإشعارات الجديدة
        function checkForNewNotifications() {
            // تحديث وقت آخر فحص
            lastNotificationCheck = new Date();
            localStorage.setItem(STORAGE_KEYS.LAST_NOTIFICATION_CHECK, lastNotificationCheck.toISOString());
            
            // تحديث العدادات
            updateNotificationsStats();
            updateNotificationBadge();
            
            // إذا كانت نافذة الإشعارات مفتوحة، قم بتحديثها
            if (document.getElementById('notificationsModal').classList.contains('show')) {
                const filterSubject = document.getElementById('filterNotificationSubject').value;
                const filterTeacher = document.getElementById('filterNotificationTeacher').value;
                const filterStatus = document.getElementById('filterNotificationStatus').value;
                displayNotifications(filterSubject, filterTeacher, filterStatus);
            }
        }
        
        // عرض الإشعارات
        function displayNotifications(filterSubject = 'all', filterTeacher = 'all', filterStatus = 'all') {
            const notificationsList = document.getElementById('notificationsList');
            
            let filteredNotifications = notifications;
            
            // تطبيق التصفية حسب المادة
            if (filterSubject !== 'all') {
                filteredNotifications = filteredNotifications.filter(n => n.teacherSubject === filterSubject);
            }
            
            // تطبيق التصفية حسب المدرس
            if (filterTeacher !== 'all') {
                filteredNotifications = filteredNotifications.filter(n => n.teacherName === filterTeacher);
            }
            
            // تطبيق التصفية حسب الحالة
            if (filterStatus !== 'all') {
                const isRead = filterStatus === 'read';
                filteredNotifications = filteredNotifications.filter(n => n.read === isRead);
            }
            
            if (filteredNotifications.length === 0) {
                notificationsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-bell-slash" style="font-size: 3rem; margin-bottom: 15px; color: #ccc;"></i>
                        <p>لا توجد إشعارات لعرضها</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            filteredNotifications.forEach(notification => {
                let actionText = '';
                let actionIcon = '';
                let actionColor = '';
                
                switch (notification.action) {
                    case 'add':
                        actionText = 'إضافة درجة جديدة';
                        actionIcon = 'fa-plus-circle';
                        actionColor = '#28a745';
                        break;
                    case 'update':
                        actionText = 'تعديل درجة';
                        actionIcon = 'fa-edit';
                        actionColor = '#ffc107';
                        break;
                    case 'delete':
                        actionText = 'حذف درجة';
                        actionIcon = 'fa-trash';
                        actionColor = '#dc3545';
                        break;
                    default:
                        actionText = 'تغيير';
                        actionIcon = 'fa-exchange-alt';
                        actionColor = '#6c5ce7';
                }
                
                const readClass = notification.read ? '' : 'unread';
                
                html += `
                    <div class="notification-item ${readClass}" id="notification-${notification.id}">
                        <div class="notification-header">
                            <span class="notification-subject">
                                <i class="fas ${actionIcon}" style="color: ${actionColor}; margin-left: 5px;"></i>
                                ${actionText}
                            </span>
                            <span class="notification-time">${notification.date} ${notification.time}</span>
                        </div>
                        
                        <div style="margin-bottom: 10px;">
                            <i class="fas fa-chalkboard-teacher" style="color: #6c5ce7;"></i>
                            <span class="notification-teacher"> ${notification.teacherName}</span>
                            <span> (${notification.teacherSubject}) </span>
                            <i class="fas fa-user-graduate" style="color: #2d3436; margin-right: 10px; margin-left: 10px;"></i>
                            <span class="notification-student"> ${notification.studentName}</span>
                        </div>
                        
                        ${notification.details ? `<p style="color: #666; font-size: 0.9rem;">${notification.details}</p>` : ''}
                        
                        <div class="notification-actions">
                            <button class="mark-read-btn" onclick="toggleNotificationRead('${notification.id}')">
                                <i class="fas ${notification.read ? 'fa-envelope' : 'fa-envelope-open'}"></i>
                                ${notification.read ? 'تعيين كغير مقروء' : 'تعيين كمقروء'}
                            </button>
                            <button class="delete-notification-btn" onclick="deleteNotification('${notification.id}')">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                            <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="toggleNotificationDetails('${notification.id}')">
                                <i class="fas fa-info-circle"></i> تفاصيل
                            </button>
                        </div>
                        
                        <div class="notification-details" id="details-${notification.id}">
                            <p><strong>التفاصيل:</strong></p>
                            ${notification.oldValue ? `<p>القيمة القديمة: ${notification.oldValue}</p>` : ''}
                            ${notification.newValue ? `<p>القيمة الجديدة: ${notification.newValue}</p>` : ''}
                            <p><strong>معرف الإشعار:</strong> ${notification.id}</p>
                        </div>
                    </div>
                `;
            });
            
            notificationsList.innerHTML = html;
        }
        
        // تبديل حالة قراءة الإشعار
        function toggleNotificationRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = !notification.read;
                if (notification.read) {
                    unreadNotificationsCount--;
                } else {
                    unreadNotificationsCount++;
                }
                
                saveToLocalStorage();
                updateNotificationBadge();
                updateNotificationsStats();
                
                // إعادة عرض الإشعارات
                const filterSubject = document.getElementById('filterNotificationSubject').value;
                const filterTeacher = document.getElementById('filterNotificationTeacher').value;
                const filterStatus = document.getElementById('filterNotificationStatus').value;
                displayNotifications(filterSubject, filterTeacher, filterStatus);
                
                showNotification('success', `تم ${notification.read ? 'تعيين الإشعار كمقروء' : 'تعيين الإشعار كغير مقروء'}`);
            }
        }
        
        // حذف إشعار
        function deleteNotification(notificationId) {
            const index = notifications.findIndex(n => n.id === notificationId);
            if (index !== -1) {
                const notification = notifications[index];
                if (!notification.read) {
                    unreadNotificationsCount--;
                }
                notifications.splice(index, 1);
                
                saveToLocalStorage();
                updateNotificationBadge();
                updateNotificationsStats();
                
                // إعادة عرض الإشعارات
                const filterSubject = document.getElementById('filterNotificationSubject').value;
                const filterTeacher = document.getElementById('filterNotificationTeacher').value;
                const filterStatus = document.getElementById('filterNotificationStatus').value;
                displayNotifications(filterSubject, filterTeacher, filterStatus);
                
                showNotification('success', 'تم حذف الإشعار');
            }
        }
        
        // عرض/إخفاء تفاصيل الإشعار
        function toggleNotificationDetails(notificationId) {
            const detailsElement = document.getElementById('details-' + notificationId);
            if (detailsElement) {
                detailsElement.classList.toggle('show');
            }
        }
        
        // تعيين جميع الإشعارات كمقروءة
        function markAllNotificationsAsRead() {
            let updatedCount = 0;
            notifications.forEach(notification => {
                if (!notification.read) {
                    notification.read = true;
                    updatedCount++;
                }
            });
            
            unreadNotificationsCount = 0;
            saveToLocalStorage();
            updateNotificationBadge();
            updateNotificationsStats();
            
            // إعادة عرض الإشعارات
            const filterSubject = document.getElementById('filterNotificationSubject').value;
            const filterTeacher = document.getElementById('filterNotificationTeacher').value;
            const filterStatus = document.getElementById('filterNotificationStatus').value;
            displayNotifications(filterSubject, filterTeacher, filterStatus);
            
            showNotification('success', `تم تعيين ${updatedCount} إشعار كمقروء`);
        }
        
        // حذف جميع الإشعارات
        function clearAllNotifications() {
            showConfirm('هل تريد حذف جميع الإشعارات؟ هذا الإجراء لا يمكن التراجع عنه.', function() {
                notifications = [];
                unreadNotificationsCount = 0;
                
                saveToLocalStorage();
                updateNotificationBadge();
                updateNotificationsStats();
                
                // إعادة عرض الإشعارات
                const filterSubject = document.getElementById('filterNotificationSubject').value;
                const filterTeacher = document.getElementById('filterNotificationTeacher').value;
                const filterStatus = document.getElementById('filterNotificationStatus').value;
                displayNotifications(filterSubject, filterTeacher, filterStatus);
                
                showNotification('success', 'تم حذف جميع الإشعارات');
            });
        }
        
        // فتح نافذة الإشعارات
        function openNotificationsModal() {
            if (!currentUser || currentUser.type !== 'admin') {
                showNotification('error', 'ليس لديك صلاحية لعرض الإشعارات');
                return;
            }
            
            // تحديث قائمة المدرسين
            updateTeachersList();
            
            // تحديث الإحصائيات
            updateNotificationsStats();
            
            // عرض الإشعارات
            displayNotifications();
            
            document.getElementById('notificationsModal').classList.add('show');
        }
        
        // تحديث قائمة المدرسين
        function updateTeachersList() {
            const teacherSelect = document.getElementById('filterNotificationTeacher');
            
            // الحصول على قائمة المدرسين الفريدة من الإشعارات
            const teachers = [...new Set(notifications.map(n => n.teacherName))];
            
            // إضافة خيار "جميع المدرسين"
            teacherSelect.innerHTML = '<option value="all">جميع المدرسين</option>';
            
            // إضافة المدرسين
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                teacherSelect.appendChild(option);
            });
        }
        
        // ========== إدارة الأكواد (للمدير فقط) ==========
        
        // عرض الأكواد الحالية
        function displayCurrentCodes() {
            if (!currentUser || currentUser.type !== 'admin') {
                showNotification('error', 'ليس لديك صلاحية للوصول إلى هذه الصفحة');
                return;
            }
            
            const codesList = document.getElementById('currentCodesList');
            let html = '';
            
            // عرض كود المدير
            html += `
                <div class="code-item">
                    <span class="subject-name">👑 المدير:</span>
                    <span class="code-value">${ADMIN_CODE}</span>
                    <button class="copy-btn" data-code="${ADMIN_CODE}">
                        <i class="fas fa-copy"></i> نسخ
                    </button>
                </div>
            `;
            
            // عرض أكواد المدرسين
            for (const [subject, code] of Object.entries(DEFAULT_CODES.subjects)) {
                html += `
                    <div class="code-item">
                        <span class="subject-name">${subject}:</span>
                        <span class="code-value">${code}</span>
                        <button class="copy-btn" data-code="${code}">
                            <i class="fas fa-copy"></i> نسخ
                        </button>
                    </div>
                `;
            }
            
            codesList.innerHTML = html;
            
            // إضافة أحداث النسخ
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const code = this.getAttribute('data-code');
                    navigator.clipboard.writeText(code).then(() => {
                        showNotification('success', 'تم نسخ الكود إلى الحافظة');
                    });
                });
            });
        }
        
        // تغيير كود مادة
        function changeSubjectCode() {
            if (!currentUser || currentUser.type !== 'admin') {
                showNotification('error', 'ليس لديك صلاحية لتغيير الأكواد');
                return;
            }
            
            const subject = document.getElementById('changeSubjectSelect').value;
            const newCode = document.getElementById('newCodeInput').value.trim().toUpperCase();
            
            if (!subject) {
                showNotification('error', 'يرجى اختيار المادة');
                return;
            }
            
            if (!newCode) {
                showNotification('error', 'يرجى إدخال الكود الجديد');
                return;
            }
            
            if (newCode.length < 6) {
                showNotification('error', 'الكود يجب أن يكون 6 أحرف على الأقل');
                return;
            }
            
            // التحقق من عدم تكرار الكود
            if (newCode === ADMIN_CODE) {
                showNotification('error', 'لا يمكن استخدام كود المدير لمادة');
                return;
            }
            
            for (const [existingSubject, existingCode] of Object.entries(DEFAULT_CODES.subjects)) {
                if (existingCode === newCode && existingSubject !== subject) {
                    showNotification('error', 'هذا الكود مستخدم بالفعل لمادة أخرى');
                    return;
                }
            }
            
            // تغيير الكود
            const oldCode = DEFAULT_CODES.subjects[subject];
            DEFAULT_CODES.subjects[subject] = newCode;
            
            // تسجيل التغيير
            logCodeChange(subject, oldCode, newCode);
            
            // إضافة إشعار
            addNotification(
                'مدير النظام',
                'إدارة الأكواد',
                'النظام',
                'update',
                oldCode,
                newCode,
                `تم تغيير كود مادة ${subject} من ${oldCode} إلى ${newCode}`
            );
            
            // تحديث العرض
            displayCurrentCodes();
            
            // إعادة تعيين الحقول
            document.getElementById('changeSubjectSelect').value = '';
            document.getElementById('newCodeInput').value = '';
            
            showNotification('success', `تم تغيير كود ${subject} من ${oldCode} إلى ${newCode}`);
        }
        
        // إعادة تعيين جميع الأكواد
        function resetAllCodes() {
            if (!currentUser || currentUser.type !== 'admin') {
                showNotification('error', 'ليس لديك صلاحية لإعادة تعيين الأكواد');
                return;
            }
            
            showConfirm('هل أنت متأكد من إعادة تعيين جميع الأكواد؟\nسيتم إنشاء أكواد جديدة لجميع المواد.', function() {
                // تسجيل الأكواد القديمة
                const oldCodes = {...DEFAULT_CODES.subjects};
                
                // إنشاء أكواد عشوائية جديدة
                for (const subject of Object.keys(DEFAULT_CODES.subjects)) {
                    const newCode = generateRandomCode();
                    DEFAULT_CODES.subjects[subject] = newCode;
                    logCodeChange(subject, oldCodes[subject], newCode);
                    
                    // إضافة إشعار لكل مادة
                    addNotification(
                        'مدير النظام',
                        'إدارة الأكواد',
                        'النظام',
                        'update',
                        oldCodes[subject],
                        newCode,
                        `تم إعادة تعيين كود مادة ${subject} إلى ${newCode}`
                    );
                }
                
                // تحديث العرض
                displayCurrentCodes();
                
                showNotification('success', 'تم إنشاء أكواد جديدة لجميع المواد');
            });
        }
        
        // إنشاء كود عشوائي
        function generateRandomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }
        
        // تسجيل تغييرات الأكواد
        function logCodeChange(subject, oldCode, newCode) {
            const log = JSON.parse(localStorage.getItem(STORAGE_KEYS.CODE_CHANGE_LOG) || '[]');
            
            log.push({
                date: new Date().toISOString(),
                subject,
                oldCode,
                newCode,
                changedBy: currentUser.name
            });
            
            // حفظ آخر 50 تغيير فقط
            if (log.length > 50) {
                log.shift();
            }
            
            localStorage.setItem(STORAGE_KEYS.CODE_CHANGE_LOG, JSON.stringify(log));
        }
        
        // طباعة الأكواد
        function printCodes() {
            if (!currentUser || currentUser.type !== 'admin') {
                showNotification('error', 'ليس لديك صلاحية لطباعة الأكواد');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            let printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>أكواد الدخول - إعدادية المجر الكبير</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #4169E1; margin-bottom: 5px; }
                        .header h2 { color: #333; margin-bottom: 20px; }
                        .code-list { margin-top: 30px; }
                        .code-item { 
                            padding: 10px; 
                            border-bottom: 1px solid #ddd;
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                        }
                        .subject-name { font-weight: bold; }
                        .code-value { font-family: monospace; font-size: 1.2rem; }
                        .footer { 
                            margin-top: 50px; 
                            text-align: center;
                            color: #666;
                            font-size: 12px;
                        }
                        @media print {
                            body { margin: 0; padding: 10px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>إعدادية المجر الكبير للبنين</h1>
                        <h2>أكواد الدخول للمدرسين</h2>
                        <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                    
                    <div class="code-list">
                        <div class="code-item" style="background-color: #f0f7ff;">
                            <span class="subject-name">👑 المدير:</span>
                            <span class="code-value">${ADMIN_CODE}</span>
                        </div>
            `;
            
            for (const [subject, code] of Object.entries(DEFAULT_CODES.subjects)) {
                printContent += `
                    <div class="code-item">
                        <span class="subject-name">${subject}:</span>
                        <span class="code-value">${code}</span>
                    </div>
                `;
            }
            
            printContent += `
                    </div>
                    
                    <div class="footer">
                        <p><strong>ملاحظات:</strong></p>
                        <p>1. هذه الأكواد سرية، يرجى حفظها في مكان آمن</p>
                        <p>2. يتم تحديث الأكواد من قبل مدير النظام فقط</p>
                        <p>3. في حالة فقدان الكود، يرجى التواصل مع المدير</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
            
            showNotification('success', 'تم فتح نافذة الطباعة');
        }
        
        // ========== وظيفة تحويل الأرقام العربية إلى إنجليزية ==========
        function convertArabicToEnglishNumber(numStr) {
            if (!numStr) return '';
            
            const arabicNumbers = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
            let result = '';
            
            for (let i = 0; i < numStr.length; i++) {
                let ch = numStr.charAt(i);
                let index = arabicNumbers.indexOf(ch);
                if (index !== -1) {
                    result += index;
                } else {
                    result += ch;
                }
            }
            return result;
        }
        
        // ========== إدارة حالة الاتصال الحقيقية ==========
        function checkInternetConnection() {
            return navigator.onLine;
        }
        
        async function testFirebaseConnection() {
            if (!isFirebaseInitialized || !db) return false;
            
            try {
                // اختبار اتصال Firebase بمحاولة قراءة وثيقة صغيرة
                const testRef = db.collection('_test_connection').doc('test');
                await testRef.get({ timeout: 5000 });
                return true;
            } catch (error) {
                console.log("اختبار اتصال Firebase فشل:", error);
                return false;
            }
        }
        
        async function updateConnectionStatus() {
            const hasInternet = checkInternetConnection();
            const hasFirebase = await testFirebaseConnection();
            
            const connectionIndicator = document.getElementById('connectionIndicator');
            const connectionText = document.getElementById('connectionText');
            const syncText = document.getElementById('syncText');
            
            if (hasInternet && hasFirebase) {
                isOnline = true;
                connectionIndicator.className = 'status-indicator status-online';
                connectionText.textContent = 'متصل بـ Firebase';
                syncText.textContent = isSyncing ? 'جاري المزامنة...' : 'متصل وجاهز للرفع';
                
                // تحديث مؤشر قائمة الانتظار
                updatePendingSyncList();
                
            } else {
                isOnline = false;
                connectionIndicator.className = 'status-indicator status-offline';
                connectionText.textContent = 'غير متصل';
                syncText.textContent = 'يعمل من النسخة المحلية';
                
                // إظهار قائمة الانتظار
                updatePendingSyncList();
            }
            
            // تحديث وقت آخر مزامنة
            updateLastSyncTime();
        }
        
        function updateLastSyncTime() {
            const lastSyncText = document.getElementById('lastSyncText');
            
            if (lastSyncTime) {
                const date = new Date(lastSyncTime);
                const formattedDate = date.toLocaleDateString('ar-EG');
                const formattedTime = date.toLocaleTimeString('ar-EG');
                lastSyncText.textContent = `آخر رفع للبيانات: ${formattedDate} ${formattedTime}`;
            } else {
                const savedLastSync = localStorage.getItem(STORAGE_KEYS.LAST_SYNC);
                if (savedLastSync) {
                    const date = new Date(savedLastSync);
                    const formattedDate = date.toLocaleDateString('ar-EG');
                    const formattedTime = date.toLocaleTimeString('ar-EG');
                    lastSyncText.textContent = `آخر رفع للبيانات: ${formattedDate} ${formattedTime}`;
                } else {
                    lastSyncText.textContent = 'آخر رفع للبيانات: --/--/---- --:--';
                }
            }
        }
        
        // ========== إشعارات التطبيق ==========
        function showNotification(type, message, duration = 3000) {
            const notification = document.getElementById(`${type}Notification`);
            const textElement = document.getElementById(`${type}NotificationText`);
            
            textElement.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }
        
        // ========== إدارة التعديلات المحلية ==========
        
        // تسجيل تعديل محلي
        function registerLocalChange(studentId, changeType, changeData) {
            const changeKey = `${studentId}_${Date.now()}`;
            localChanges.set(changeKey, {
                studentId: studentId,
                type: changeType,
                data: changeData,
                timestamp: new Date().toISOString()
            });
            
            // حفظ التعديلات محلياً
            saveToLocalStorage();
            
            // تحديث قائمة الانتظار
            updatePendingSyncList();
            
            return changeKey;
        }
        
        // ========== دالة رفع البيانات إلى السيرفر ==========
        async function uploadToServer() {
            if (!isOnline) {
                showNotification('error', 'لا يوجد اتصال بالإنترنت للرفع');
                return;
            }
            
            if (!isFirebaseInitialized || !db) {
                showNotification('error', 'Firebase غير مهيئ');
                return;
            }
            
            if (students.length === 0) {
                showNotification('warning', 'لا توجد بيانات للرفع');
                return;
            }
            
            showNotification('sync', 'جاري رفع البيانات إلى السيرفر...', 10000);
            isSyncing = true;
            updateConnectionStatus();
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                // رفع جميع الطلاب إلى Firebase
                for (const student of students) {
                    try {
                        // إذا كان الطالب لديه id من Firebase (مسبقاً تم رفعه)
                        if (student.id && !student.id.startsWith('temp_')) {
                            // تحديث الطالب الموجود
                            await db.collection('students').doc(student.id).update({
                                name: student.name,
                                class: student.class,
                                division: student.division,
                                parentPhone: student.parentPhone,
                                grades: student.grades || {},
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            successCount++;
                        } else {
                            // إضافة طالب جديد
                            const docRef = await db.collection('students').add({
                                name: student.name,
                                class: student.class,
                                division: student.division,
                                parentPhone: student.parentPhone,
                                grades: student.grades || {},
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            // تحديث المعرف في المصفوفة المحلية
                            const studentIndex = students.findIndex(s => 
                                s.tempId === student.tempId || 
                                (s.id && s.id === student.id)
                            );
                            
                            if (studentIndex !== -1) {
                                students[studentIndex].id = docRef.id;
                                delete students[studentIndex].tempId;
                            }
                            successCount++;
                        }
                    } catch (error) {
                        console.error(`خطأ في رفع الطالب ${student.name}:`, error);
                        errorCount++;
                    }
                }
                
                // مسح التعديلات المحلية بعد الرفع الناجح
                localChanges.clear();
                pendingSyncQueue = [];
                
                // تحديث وقت آخر رفع
                lastSyncTime = new Date();
                
                // حفظ محلياً
                saveToLocalStorage();
                
                // تحديث العرض
                updateLastSyncTime();
                updateStorageStatus();
                updatePendingSyncList();
                
                isSyncing = false;
                updateConnectionStatus();
                
                if (errorCount === 0) {
                    showNotification('success', `تم رفع ${successCount} طالب بنجاح`);
                } else {
                    showNotification('warning', `تم رفع ${successCount} طالب، فشل رفع ${errorCount} طالب`);
                }
                
            } catch (error) {
                console.error("خطأ في رفع البيانات إلى السيرفر:", error);
                isSyncing = false;
                updateConnectionStatus();
                showNotification('error', 'حدث خطأ أثناء رفع البيانات');
            }
        }
        
        // ========== دالة استيراد البيانات من السيرفر ==========
        async function downloadFromServer() {
            if (!isOnline) {
                showNotification('error', 'لا يوجد اتصال بالإنترنت للاستيراد');
                return;
            }
            
            showConfirm('هل تريد استيراد جميع البيانات من السيرفر؟ سيتم حذف جميع البيانات المحلية واستبدالها بالبيانات الجديدة.', async function() {
                if (!isFirebaseInitialized || !db) {
                    showNotification('error', 'Firebase غير مهيئ');
                    return;
                }
                
                showNotification('sync', 'جاري حذف البيانات المحلية واستيراد البيانات من السيرفر...', 5000);
                
                try {
                    // 1. حذف جميع البيانات المحلية أولاً
                    students = [];
                    pendingSyncQueue = [];
                    localChanges.clear();
                    lastSyncTime = null;
                    
                    // حذف جميع البيانات من localStorage
                    localStorage.removeItem(STORAGE_KEYS.STUDENTS);
                    localStorage.removeItem(STORAGE_KEYS.PENDING_SYNC);
                    localStorage.removeItem(STORAGE_KEYS.LAST_SYNC);
                    localStorage.removeItem(STORAGE_KEYS.LOCAL_CHANGES);
                    
                    // 2. استيراد البيانات من Firebase
                    const snapshot = await db.collection('students').get();
                    const serverStudents = [];
                    
                    snapshot.forEach(doc => {
                        const studentData = doc.data();
                        serverStudents.push({
                            id: doc.id,
                            ...studentData
                        });
                    });
                    
                    if (serverStudents.length === 0) {
                        showNotification('warning', 'لا توجد بيانات على السيرفر');
                        return;
                    }
                    
                    // 3. استبدال البيانات المحلية ببيانات السيرفر
                    students = serverStudents;
                    
                    // 4. تحديث وقت آخر مزامنة
                    lastSyncTime = new Date();
                    
                    // 5. حفظ محلياً
                    saveToLocalStorage();
                    
                    // 6. تحديث العرض
                    updateStats();
                    updateLastSyncTime();
                    updateStorageStatus();
                    updatePendingSyncList();
                    
                    // 7. عرض قائمة الطلاب
                    displayAllStudents();
                    
                    showNotification('success', `تم حذف البيانات المحلية واستيراد ${serverStudents.length} طالب من السيرفر بنجاح`);
                    
                } catch (error) {
                    console.error("خطأ في استيراد البيانات من السيرفر:", error);
                    showNotification('error', 'حدث خطأ أثناء استيراد البيانات من السيرفر');
                }
            });
        }
        
        // ========== دالة رفع التعديلات المحلية فقط ==========
        async function uploadLocalChangesToServer() {
            if (!isOnline) {
                showNotification('error', 'لا يوجد اتصال بالإنترنت للرفع');
                return;
            }
            
            if (!isFirebaseInitialized || !db) {
                showNotification('error', 'Firebase غير مهيئ');
                return;
            }
            
            if (localChanges.size === 0 && pendingSyncQueue.length === 0) {
                showNotification('info', 'لا توجد تعديلات محلية للرفع');
                return;
            }
            
            showNotification('sync', 'جاري رفع التعديلات إلى السيرفر...', 10000);
            isSyncing = true;
            updateConnectionStatus();
            
            let successCount = 0;
            let errorCount = 0;
            
            try {
                // معالجة التعديلات المحلية (localChanges)
                if (localChanges.size > 0) {
                    const changesToSync = Array.from(localChanges.entries());
                    
                    for (const [changeKey, change] of changesToSync) {
                        try {
                            const studentId = change.studentId;
                            const student = students.find(s => 
                                s.id === studentId || 
                                s.tempId === studentId || 
                                (s.id && !s.id.startsWith('temp_') && s.id === studentId)
                            );
                            
                            if (!student) {
                                console.warn(`الطالب غير موجود: ${studentId}`);
                                localChanges.delete(changeKey);
                                continue;
                            }
                            
                            switch (change.type) {
                                case 'addStudent':
                                    if (!student.id || student.id.startsWith('temp_')) {
                                        // إضافة طالب جديد
                                        const docRef = await db.collection('students').add({
                                            name: student.name,
                                            class: student.class,
                                            division: student.division,
                                            parentPhone: student.parentPhone,
                                            grades: student.grades || {},
                                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                        
                                        // تحديث المعرف في المصفوفة المحلية
                                        const studentIndex = students.findIndex(s => 
                                            s.tempId === student.tempId
                                        );
                                        
                                        if (studentIndex !== -1) {
                                            students[studentIndex].id = docRef.id;
                                            delete students[studentIndex].tempId;
                                        }
                                        successCount++;
                                    }
                                    break;
                                    
                                case 'updateGrades':
                                    if (student.id && !student.id.startsWith('temp_')) {
                                        await db.collection('students').doc(student.id).update({
                                            grades: student.grades || {},
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                        successCount++;
                                    }
                                    break;
                                    
                                case 'updateStudent':
                                    if (student.id && !student.id.startsWith('temp_')) {
                                        await db.collection('students').doc(student.id).update({
                                            ...change.data.updates,
                                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                        successCount++;
                                    }
                                    break;
                            }
                            
                            // حذف التعديل بعد النجاح
                            localChanges.delete(changeKey);
                            
                        } catch (error) {
                            console.error(`فشل رفع التعديل ${changeKey}:`, error);
                            errorCount++;
                        }
                    }
                }
                
                // تحديث وقت آخر رفع
                lastSyncTime = new Date();
                
                // حفظ محلياً
                saveToLocalStorage();
                
                // تحديث العرض
                updateLastSyncTime();
                updateStorageStatus();
                updatePendingSyncList();
                
                isSyncing = false;
                updateConnectionStatus();
                
                if (errorCount === 0) {
                    showNotification('success', `تم رفع ${successCount} تعديل بنجاح`);
                } else {
                    showNotification('warning', `تم رفع ${successCount} تعديل، فشل رفع ${errorCount} تعديل`);
                }
                
            } catch (error) {
                console.error("خطأ في رفع التعديلات إلى السيرفر:", error);
                isSyncing = false;
                updateConnectionStatus();
                showNotification('error', 'حدث خطأ أثناء رفع التعديلات');
            }
        }
        
        // ========== إدارة قائمة الانتظار للمزامنة ==========
        function addToSyncQueue(action, data) {
            const pendingId = Date.now();
            const pendingItem = {
                id: pendingId,
                action: action,
                data: data,
                timestamp: new Date(),
                status: 'pending',
                attempts: 0
            };
            
            pendingSyncQueue.push(pendingItem);
            
            // حفظ محلياً
            saveToLocalStorage();
            
            updatePendingSyncList();
            
            return pendingId;
        }
        
        function removeFromSyncQueue(itemId) {
            const index = pendingSyncQueue.findIndex(item => item.id === itemId);
            if (index !== -1) {
                pendingSyncQueue.splice(index, 1);
                saveToLocalStorage();
                updatePendingSyncList();
            }
        }
        
        function updatePendingSyncList() {
            const pendingCount = document.getElementById('pendingCount');
            const pendingSyncItems = document.getElementById('pendingSyncItems');
            const pendingSyncList = document.getElementById('pendingSyncList');
            
            const totalPending = pendingSyncQueue.length + localChanges.size;
            pendingCount.textContent = totalPending;
            
            if (totalPending > 0) {
                pendingSyncList.classList.add('show');
                
                let itemsHTML = '';
                
                // عرض التعديلات المحلية
                if (localChanges.size > 0) {
                    itemsHTML += `<div class="pending-sync-item"><i class="fas fa-edit"></i> ${localChanges.size} تعديل محلي</div>`;
                }
                
                // عرض عناصر من قائمة الانتظار (حد أقصى 4)
                pendingSyncQueue.slice(0, 4).forEach(item => {
                    let actionText = '';
                    switch (item.action) {
                        case 'addStudent':
                            actionText = `إضافة طالب: ${item.data.name}`;
                            break;
                        case 'updateGrades':
                            actionText = `تحديث درجات`;
                            break;
                        case 'deleteStudent':
                            actionText = `حذف طالب`;
                            break;
                        case 'updateStudent':
                            actionText = `تحديث بيانات`;
                            break;
                        default:
                            actionText = 'عملية رفع';
                    }
                    
                    const time = new Date(item.timestamp).toLocaleTimeString('ar-EG');
                    itemsHTML += `
                        <div class="pending-sync-item">
                            <i class="fas fa-clock"></i> ${actionText} (${time})
                        </div>
                    `;
                });
                
                if (totalPending > 5) {
                    itemsHTML += `<div class="pending-sync-item">و ${totalPending - 4} عملية أخرى...</div>`;
                }
                
                pendingSyncItems.innerHTML = itemsHTML;
            } else {
                pendingSyncList.classList.remove('show');
            }
        }
        
        // ========== تحميل البيانات من Firebase (للجلب فقط) ==========
        async function loadFromFirebase() {
            if (!isOnline || !isFirebaseInitialized) return false;
            
            try {
                showNotification('info', 'جاري تحميل البيانات من السحابة...', 3000);
                
                const snapshot = await db.collection('students').get();
                
                const firebaseStudents = [];
                snapshot.forEach(doc => {
                    const studentData = doc.data();
                    firebaseStudents.push({
                        id: doc.id,
                        ...studentData
                    });
                });
                
                console.log(`تم تحميل ${firebaseStudents.length} طالب من Firebase`);
                
                // دمج البيانات المحلية مع بيانات Firebase
                const mergedStudents = [...students];
                
                firebaseStudents.forEach(fbStudent => {
                    const existingIndex = mergedStudents.findIndex(s => s.id === fbStudent.id);
                    if (existingIndex === -1) {
                        // إضافة طالب جديد من Firebase
                        mergedStudents.push(fbStudent);
                    }
                });
                
                students = mergedStudents;
                
                // حفظ محلياً
                saveToLocalStorage();
                
                // تحديث العرض
                updateStats();
                if (document.getElementById('studentsSection').style.display === 'block') {
                    displayAllStudents();
                }
                
                showNotification('success', `تم تحميل ${firebaseStudents.length} طالب من السحابة`);
                
                return true;
            } catch (error) {
                console.error("خطأ في تحميل البيانات من Firebase:", error);
                showNotification('error', 'فشل تحميل البيانات من السحابة');
                return false;
            }
        }
        
        // ========== النسخ الاحتياطي المحلي ==========
        function createLocalBackup() {
            const backupData = {
                students: students,
                notifications: notifications,
                timestamp: new Date().toISOString(),
                totalStudents: students.length,
                totalNotifications: notifications.length,
                lastSync: lastSyncTime ? lastSyncTime.toISOString() : null,
                appVersion: APP_VERSION
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `students_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showNotification('success', `تم إنشاء نسخة احتياطية محلية`);
        }
        
        function restoreFromLocalFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        if (!backupData.students || !Array.isArray(backupData.students)) {
                            throw new Error("تنسيق الملف غير صالح");
                        }
                        
                        if (backupData.students.length === 0) {
                            showNotification('warning', 'الملف لا يحتوي على بيانات طلاب');
                            return;
                        }
                        
                        // عرض تأكيد الاستعادة
                        showConfirm(`هل تريد استعادة ${backupData.students.length} طالب و ${backupData.notifications?.length || 0} إشعار؟\n\nتحذير: سيتم استبدال جميع البيانات الحالية.`, function() {
                            students = backupData.students;
                            
                            // استعادة الإشعارات إذا كانت موجودة
                            if (backupData.notifications && Array.isArray(backupData.notifications)) {
                                notifications = backupData.notifications;
                                unreadNotificationsCount = notifications.filter(n => !n.read).length;
                            }
                            
                            // مسح التعديلات المحلية
                            localChanges.clear();
                            pendingSyncQueue = [];
                            
                            // حفظ محلياً
                            saveToLocalStorage();
                            
                            if (backupData.lastSync) {
                                lastSyncTime = new Date(backupData.lastSync);
                            }
                            
                            // تحديث العرض
                            updateStats();
                            updateNotificationsStats();
                            displayAllStudents();
                            updateLastSyncTime();
                            updateStorageStatus();
                            
                            showNotification('success', `تم استعادة ${students.length} طالب و ${notifications.length} إشعار بنجاح`);
                            
                            // عرض خيار رفع البيانات المستعادة
                            if (isOnline) {
                                setTimeout(() => {
                                    showConfirm('هل تريد رفع البيانات المستعادة إلى السيرفر الآن؟', function() {
                                        uploadToServer();
                                    });
                                }, 2000);
                                }
                        });
                    } catch (error) {
                        showNotification('error', `خطأ في تحميل الملف: ${error.message}`);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function exportToExcel() {
            if (students.length === 0) {
                showNotification('warning', 'لا توجد بيانات للتصدير');
                return;
            }
            
            // إنشاء بيانات Excel مبسطة
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // عنوان الملف
            csvContent += "نظام إدارة درجات الطلاب - إعدادية المجر الكبير للبنين\n";
            csvContent += `تاريخ التصدير: ${new Date().toLocaleDateString('ar-EG')}\n`;
            csvContent += `إجمالي الطلاب: ${students.length}\n\n`;
            
            // رأس الجدول
            csvContent += "الاسم,الصف,الشعبة,رقم الهاتف,المادة,الشهر1 الفصل1,الشهر2 الفصل1,السعي,نصف السنة,الشهر1 الفصل2,الشهر2 الفصل2,السعي,نهاية السنة,المعدل النهائي\n";
            
            // بيانات الطلاب
            students.forEach(student => {
                const subjects = subjectsByClass[student.class] || [];
                subjects.forEach(subject => {
                    const grades = student.grades[subject] || {
                        firstTerm: { month1: '', month2: '', midterm: '' },
                        secondTerm: { month1: '', month2: '', final: '' },
                        finalAverage: ''
                    };
                    
                    // حساب السعي
                    const month1First = grades.firstTerm.month1 || 0;
                    const month2First = grades.firstTerm.month2 || 0;
                    const firstMonthly = (month1First && month2First) ? Math.round((parseInt(month1First) + parseInt(month2First)) / 2) : '';
                    
                    const month1Second = grades.secondTerm.month1 || 0;
                    const month2Second = grades.secondTerm.month2 || 0;
                    const secondMonthly = (month1Second && month2Second) ? Math.round((parseInt(month1Second) + parseInt(month2Second)) / 2) : '';
                    
                    csvContent += `"${student.name}",${student.class},${student.division},${student.parentPhone},"${subject}",${grades.firstTerm.month1 || ''},${grades.firstTerm.month2 || ''},${firstMonthly},${grades.firstTerm.midterm || ''},${grades.secondTerm.month1 || ''},${grades.secondTerm.month2 || ''},${secondMonthly},${grades.secondTerm.final || ''},${grades.finalAverage || ''}\n`;
                });
            });
            
            // تحميل الملف
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `students_export_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('success', `تم تصدير البيانات`);
        }
        
        // ========== حذف كافة البيانات ==========
        async function deleteAllData() {
            document.getElementById('deleteAllModal').classList.add('show');
        }
        
        async function confirmDeleteAllData() {
            try {
                // حذف من Firebase إذا كان متصلاً
                if (isOnline && isFirebaseInitialized) {
                    showNotification('sync', 'جاري حذف البيانات من السحابة...', 5000);
                    
                    try {
                        const snapshot = await db.collection('students').get();
                        const batch = db.batch();
                        
                        snapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        console.log("تم حذف جميع البيانات من Firebase");
                    } catch (error) {
                        console.error("خطأ في حذف البيانات من Firebase:", error);
                        // نستمر في حذف البيانات المحلية حتى لو فشل حذف السحابة
                    }
                }
                
                // حذف البيانات المحلية
                students = [];
                notifications = [];
                pendingSyncQueue = [];
                localChanges.clear();
                lastSyncTime = null;
                unreadNotificationsCount = 0;
                
                // حذف جميع البيانات من localStorage
                localStorage.removeItem(STORAGE_KEYS.STUDENTS);
                localStorage.removeItem(STORAGE_KEYS.PENDING_SYNC);
                localStorage.removeItem(STORAGE_KEYS.LAST_SYNC);
                localStorage.removeItem(STORAGE_KEYS.LOCAL_CHANGES);
                localStorage.removeItem(STORAGE_KEYS.NOTIFICATIONS);
                
                // إعادة تعيين التطبيق
                updateStats();
                updateNotificationsStats();
                updateStorageStatus();
                updateLastSyncTime();
                updatePendingSyncList();
                updateNotificationBadge();
                
                // إغلاق جميع الأقسام
                document.getElementById('studentsSection').style.display = 'none';
                document.getElementById('gradesSection').style.display = 'none';
                document.getElementById('addStudentSection').style.display = 'none';
                document.getElementById('bulkImportSection').style.display = 'none';
                
                // إغلاق النافذة
                document.getElementById('deleteAllModal').classList.remove('show');
                
                showNotification('success', 'تم حذف كافة البيانات بنجاح');
                
            } catch (error) {
                console.error("خطأ في حذف جميع البيانات:", error);
                showNotification('error', 'حدث خطأ أثناء حذف البيانات');
            }
        }
        
        // ========== استيراد أسماء دفعة واحدة ==========
        function showBulkImport() {
            document.getElementById('studentsSection').style.display = 'none';
            document.getElementById('gradesSection').style.display = 'none';
            document.getElementById('addStudentSection').style.display = 'none';
            document.getElementById('bulkImportSection').style.display = 'block';
            
            // تحديث عداد الأسماء
            updateNamesCounter();
        }
        
        function updateNamesCounter() {
            const namesText = document.getElementById('bulkNames').value;
            const lines = namesText.split('\n').filter(line => line.trim() !== '');
            document.getElementById('namesCounter').textContent = `عدد الأسماء: ${lines.length}`;
        }
        
        function previewBulkNames() {
            const namesText = document.getElementById('bulkNames').value;
            const lines = namesText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                document.getElementById('previewNames').style.display = 'none';
                showNotification('warning', 'لم تقم بإدخال أي أسماء');
                return;
            }
            
            const previewList = document.getElementById('previewList');
            previewList.innerHTML = '';
            
            lines.forEach((name, index) => {
                if (index < 50) { // عرض أول 50 اسم فقط
                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'preview-item';
                    nameDiv.textContent = `${index + 1}. ${name.trim()}`;
                    previewList.appendChild(nameDiv);
                }
            });
            
            if (lines.length > 50) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'preview-item';
                moreDiv.textContent = `... و ${lines.length - 50} اسم إضافي`;
                previewList.appendChild(moreDiv);
            }
            
            document.getElementById('previewNames').style.display = 'block';
        }
        
        async function importBulkNames() {
            const namesText = document.getElementById('bulkNames').value;
            const studentClass = document.getElementById('bulkClass').value;
            const division = document.getElementById('bulkDivision').value;
            
            if (!studentClass || !division) {
                showNotification('warning', 'يرجى اختيار الصف والشعبة');
                return;
            }
            
            const lines = namesText.split('\n').filter(line => line.trim() !== '');
            
            if (lines.length === 0) {
                showNotification('warning', 'لم تقم بإدخال أي أسماء');
                return;
            }
            
            // التحقق من الصلاحيات
            if (currentUser.type === 'teacher') {
                showNotification('error', 'ليس لديك صلاحية لإضافة طلاب');
                return;
            }
            
            let addedCount = 0;
            let skippedCount = 0;
            
            for (const line of lines) {
                const name = line.trim();
                if (name === '') continue;
                
                // التحقق من عدم وجود الطالب مسبقاً
                const existingStudent = students.find(s => 
                    s.name === name && 
                    s.class === studentClass && 
                    s.division === division
                );
                
                if (!existingStudent) {
                    // إنشاء درجات فارغة للطالب
                    const defaultGrades = {};
                    subjectsByClass[studentClass].forEach(subject => {
                        defaultGrades[subject] = {
                            firstTerm: {
                                month1: '',
                                month2: '',
                                midterm: ''
                            },
                            secondTerm: {
                                month1: '',
                                month2: '',
                                final: ''
                            },
                            finalAverage: ''
                        };
                    });
                    
                    // إنشاء tempId مؤقت للطالب الجديد
                    const tempId = 'temp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    
                    // إنشاء كائن الطالب
                    const newStudent = {
                        tempId: tempId,
                        name,
                        class: studentClass,
                        division,
                        parentPhone: 'لم يتم إضافته',
                        grades: defaultGrades,
                        createdAt: new Date().toISOString(),
                        localUpdateTime: Date.now() // تخزين وقت التحديث المحلي
                    };
                    
                    // إضافة الطالب إلى المصفوفة المحلية
                    students.push(newStudent);
                    addedCount++;
                    
                    // إضافة التعديل إلى localChanges للمزامنة لاحقاً
                    registerLocalChange(tempId, 'addStudent', newStudent);
                    
                    // إضافة إشعار للمدير
                    addNotification(
                        currentUser.name,
                        currentUser.role,
                        name,
                        'add',
                        null,
                        null,
                        `تم إضافة طالب جديد: ${name} في الصف ${studentClass} - الشعبة ${division}`
                    );
                    
                } else {
                    skippedCount++;
                }
            }
            
            // حفظ محلياً
            saveToLocalStorage();
            
            // تحديث العرض
            updateStats();
            updateNotificationsStats();
            displayAllStudents();
            updatePendingSyncList();
            
            // إغلاق قسم الاستيراد
            document.getElementById('bulkImportSection').style.display = 'none';
            document.getElementById('studentsSection').style.display = 'block';
            
            // إعادة تعيين النموذج
            document.getElementById('bulkImportForm').reset();
            document.getElementById('previewNames').style.display = 'none';
            
            showNotification('success', `تمت إضافة ${addedCount} طالب بنجاح${skippedCount > 0 ? `، تم تخطي ${skippedCount} طالب موجودين مسبقاً` : ''}`);
            
            // عرض خيار رفع البيانات الجديدة
            if (isOnline) {
                setTimeout(() => {
                    showConfirm('هل تريد رفع الطلاب الجدد إلى السيرفر الآن؟', function() {
                        uploadLocalChangesToServer();
                    });
                }, 1000);
            }
        }
        
        // ========== ترتيب أسماء الطلاب أبجدياً حسب الأحرف العربية ==========
        function sortStudentsAlphabetically(studentList) {
            return studentList.sort((a, b) => {
                return a.name.localeCompare(b.name, 'ar');
            });
        }
        
        // ========== عرض جميع الطلاب مع التصفية الفورية ==========
        function displayAllStudents() {
            const filterClass = document.getElementById('filterClass').value;
            const filterDivision = document.getElementById('filterDivision').value;
            const tbody = document.getElementById('studentsTableBody');
            
            let filteredStudents = students;
            
            // تطبيق تصفية الصف
            if (filterClass !== 'all') {
                filteredStudents = filteredStudents.filter(student => student.class === filterClass);
            }
            
            // تطبيق تصفية الشعبة
            if (filterDivision !== 'all') {
                filteredStudents = filteredStudents.filter(student => student.division === filterDivision);
            }
            
            // ترتيب الطلاب أبجدياً
            filteredStudents = sortStudentsAlphabetically(filteredStudents);
            
            if (filteredStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px;">
                            <i class="fas fa-user-slash" style="font-size: 2rem; color: #ccc; margin-bottom: 15px; display: block;"></i>
                            <p>لا يوجد طلاب مسجلين في النظام</p>
                            <button class="btn btn-primary" id="addFirstStudent" style="margin-top: 15px;">
                                <i class="fas fa-user-plus"></i> إضافة أول طالب
                            </button>
                        </td>
                    </tr>
                `;
                
                document.getElementById('addFirstStudent').addEventListener('click', function() {
                    document.getElementById('addStudentBtn').click();
                });
                
                document.getElementById('studentsSection').style.display = 'block';
                return;
            }
            
            let tableHTML = '';
            filteredStudents.forEach((student, index) => {
                let classText = '';
                let classBadge = '';
                if (student.class === '4') {
                    classText = 'الرابع العلمي';
                    classBadge = 'class-4';
                } else if (student.class === '5') {
                    classText = 'الخامس العلمي';
                    classBadge = 'class-5';
                } else if (student.class === '6') {
                    classText = 'السادس العلمي';
                    classBadge = 'class-6';
                }
                
                const studentId = student.id || student.tempId;
                
                tableHTML += `
                    <tr id="student-row-${studentId}">
                        <td>${index + 1}. ${student.name}</td>
                        <td><span class="class-badge ${classBadge}">${classText}</span></td>
                        <td>${student.division}</td>
                        <td>${student.parentPhone}</td>
                        <td>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-primary" style="padding: 8px 15px; font-size: 0.9rem;" onclick="showStudentGrades('${studentId}')">
                                    <i class="fas fa-eye"></i> عرض/تعديل الدرجات
                                </button>
                                <button class="btn btn-danger" style="padding: 8px 15px; font-size: 0.9rem;" onclick="showDeleteModal('${studentId}', '${student.name}')">
                                    <i class="fas fa-trash"></i> حذف الطالب
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = tableHTML;
            document.getElementById('studentsSection').style.display = 'block';
        }
        
        // ========== تهيئة التطبيق ==========
        function initializeApp() {
            // تحميل البيانات من التخزين المحلي أولاً
            loadFromLocalStorage();
            
            // تحديث العرض
            updateStats();
            updateNotificationsStats();
            updateLastSyncTime();
            updateStorageStatus();
            updatePendingSyncList();
            
            // عرض الطلاب إذا كان هناك بيانات
            if (students.length > 0) {
                displayAllStudents();
            }
            
            // إخفاء شاشة التحميل
            setTimeout(() => {
                document.getElementById('firebaseLoading').style.display = 'none';
            }, 500);
            
            // محاولة الاتصال بـ Firebase
            setTimeout(async () => {
                await updateConnectionStatus();
            }, 1000);
            
            // بدء التحديث التلقائي كل دقيقة (60000 ميلي ثانية)
            setInterval(checkForNewNotifications, 60000);
        }
        
        // ========== عرض درجات الطالب مع الصلاحيات ==========
        function showStudentGrades(studentId) {
            currentStudentId = studentId;
            const student = students.find(s => (s.id == studentId) || (s.tempId == studentId));
            
            if (!student) {
                showNotification('error', 'لم يتم العثور على بيانات الطالب');
                return;
            }
            
            // تحديث معلومات الطالب
            let classText = '';
            if (student.class === '4') classText = 'الرابع العلمي';
            else if (student.class === '5') classText = 'الخامس العلمي';
            else if (student.class === '6') classText = 'السادس العلمي';
            
            document.getElementById('studentName').textContent = student.name;
            document.getElementById('studentClass').textContent = `الصف: ${classText}`;
            document.getElementById('studentDivision').textContent = `الشعبة: ${student.division}`;
            document.getElementById('studentParentPhone').textContent = `رقم هاتف ولي الأمر: ${student.parentPhone}`;
            
            // إنشاء جدول الدرجات مع الصلاحيات
            const gradesTable = document.getElementById('gradesTable');
            let tableHTML = '';
            
            tableHTML = `
                <thead>
                    <tr>
                        <th rowspan="2" class="subject-header">المادة</th>
                        <th colspan="4" class="term-header">الفصل الأول</th>
                        <th colspan="4" class="term-header">الفصل الثاني</th>
                        <th rowspan="2" class="subject-header">المعدل النهائي</th>
                    </tr>
                    <tr>
                        <th>امتحان الشهر الأول</th>
                        <th>امتحان الشهر الثاني</th>
                        <th>السعي</th>
                        <th>نصف السنة</th>
                        <th>امتحان الشهر الأول</th>
                        <th>امتحان الشهر الثاني</th>
                        <th>السعي</th>
                        <th>اختبار نهاية السنة</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            const subjects = subjectsByClass[student.class] || [];
            subjects.forEach(subject => {
                const subjectGrades = student.grades[subject] || {
                    firstTerm: { month1: '', month2: '', midterm: '' },
                    secondTerm: { month1: '', month2: '', final: '' },
                    finalAverage: ''
                };
                
                // حساب السعي (المتوسط)
                const month1First = subjectGrades.firstTerm.month1 || '';
                const month2First = subjectGrades.firstTerm.month2 || '';
                let firstTermMonthly = '';
                
                if (month1First && month2First) {
                    const num1 = parseInt(convertArabicToEnglishNumber(month1First));
                    const num2 = parseInt(convertArabicToEnglishNumber(month2First));
                    if (!isNaN(num1) && !isNaN(num2)) {
                        firstTermMonthly = Math.round((num1 + num2) / 2);
                    }
                }
                
                const month1Second = subjectGrades.secondTerm.month1 || '';
                const month2Second = subjectGrades.secondTerm.month2 || '';
                let secondTermMonthly = '';
                
                if (month1Second && month2Second) {
                    const num1 = parseInt(convertArabicToEnglishNumber(month1Second));
                    const num2 = parseInt(convertArabicToEnglishNumber(month2Second));
                    if (!isNaN(num1) && !isNaN(num2)) {
                        secondTermMonthly = Math.round((num1 + num2) / 2);
                    }
                }
                
                const finalAverage = subjectGrades.finalAverage || '';
                
                const getGradeClass = (grade) => {
                    if (!grade) return 'grade-average';
                    const numGrade = parseInt(grade);
                    if (isNaN(numGrade)) return 'grade-average';
                    if (numGrade >= 70) return 'grade-excellent';
                    if (numGrade >= 50) return 'grade-average';
                    return 'grade-fail';
                };
                
                const finalGradeClass = getGradeClass(finalAverage);
                const firstMonthlyClass = getGradeClass(firstTermMonthly);
                const secondMonthlyClass = getGradeClass(secondTermMonthly);
                
                // تحديد ما إذا كان المستخدم لديه صلاحية تعديل هذه المادة
                const canEdit = currentUser.type === 'admin' || 
                               (currentUser.type === 'teacher' && currentUser.subject === subject);
                
                const readOnlyClass = canEdit ? '' : 'readonly-grade';
                const readOnlyAttr = canEdit ? '' : 'readonly';
                
                tableHTML += `
                    <tr data-subject="${subject}">
                        <td class="subject-header">${subject}</td>
                        
                        <!-- الفصل الأول -->
                        <td>
                            <input type="text" pattern="[0-9٠-٩]*" 
                                   class="grade-input first-month1 ${readOnlyClass}" 
                                   value="${subjectGrades.firstTerm.month1 || ''}"
                                   data-term="first" data-type="month1" ${readOnlyAttr}>
                        </td>
                        <td>
                            <input type="text" pattern="[0-9٠-٩]*" 
                                   class="grade-input first-month2 ${readOnlyClass}" 
                                   value="${subjectGrades.firstTerm.month2 || ''}"
                                   data-term="first" data-type="month2" ${readOnlyAttr}>
                        </td>
                        <td>
                            <span class="grade-value ${firstMonthlyClass} first-monthly">
                                ${firstTermMonthly || ''}
                            </span>
                        </td>
                        <td>
                            <input type="text" pattern="[0-9٠-٩]*" 
                                   class="grade-input first-midterm ${readOnlyClass}" 
                                   value="${subjectGrades.firstTerm.midterm || ''}"
                                   data-term="first" data-type="midterm" ${readOnlyAttr}>
                        </td>
                        
                        <!-- الفصل الثاني -->
                        <td>
                            <input type="text" pattern="[0-9٠-٩]*" 
                                   class="grade-input second-month1 ${readOnlyClass}" 
                                   value="${subjectGrades.secondTerm.month1 || ''}"
                                   data-term="second" data-type="month1" ${readOnlyAttr}>
                        </td>
                        <td>
                            <input type="text" pattern="[0-9٠-٩]*" 
                                   class="grade-input second-month2 ${readOnlyClass}" 
                                   value="${subjectGrades.secondTerm.month2 || ''}"
                                   data-term="second" data-type="month2" ${readOnlyAttr}>
                        </td>
                        <td>
                            <span class="grade-value ${secondMonthlyClass} second-monthly">
                                ${secondTermMonthly || ''}
                            </span>
                        </td>
                        <td>
                            <input type="text" pattern="[0-9٠-٩]*" 
                                   class="grade-input second-final ${readOnlyClass}" 
                                   value="${subjectGrades.secondTerm.final || ''}"
                                   data-term="second" data-type="final" ${readOnlyAttr}>
                        </td>
                        
                        <!-- المعدل النهائي -->
                        <td>
                            <input type="text" pattern="[0-9٠-٩]*" 
                                   class="grade-input final-average-input ${readOnlyClass}" 
                                   value="${finalAverage}"
                                   data-type="finalAverage" ${readOnlyAttr}>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody>';
            gradesTable.innerHTML = tableHTML;
            
            // إعداد معالجات الأحداث لحقول الدرجات (فقط للحقول القابلة للتعديل)
            setupGradeInputListeners();
            
            document.getElementById('studentsSection').style.display = 'none';
            document.getElementById('addStudentSection').style.display = 'none';
            document.getElementById('bulkImportSection').style.display = 'none';
            document.getElementById('gradesSection').style.display = 'block';
        }
        
        // إعداد معالجات الأحداث لحقول الدرجات
        function setupGradeInputListeners() {
            document.querySelectorAll('.grade-input:not(.readonly-grade)').forEach(input => {
                input.addEventListener('input', function() {
                    // التحقق من أن المدخل يحتوي على أرقام فقط (إنجليزية أو عربية)
                    this.value = this.value.replace(/[^0-9٠-٩]/g, '');
                    
                    if (this.getAttribute('data-type') === 'month1' || this.getAttribute('data-type') === 'month2') {
                        updateMonthlyAverage(this);
                    }
                });
                
                input.addEventListener('change', function() {
                    if (this.getAttribute('data-type') === 'month1' || this.getAttribute('data-type') === 'month2') {
                        updateMonthlyAverage(this);
                    }
                });
            });
        }
        
        // تحديث السعي
        function updateMonthlyAverage(inputElement) {
            const row = inputElement.closest('tr');
            const subject = row.getAttribute('data-subject');
            const term = inputElement.getAttribute('data-term');
            const type = inputElement.getAttribute('data-type');
            
            const month1Input = row.querySelector(`.${term}-month1`);
            const month2Input = row.querySelector(`.${term}-month2`);
            const monthlySpan = row.querySelector(`.${term}-monthly`);
            
            // تحويل الأرقام العربية إلى إنجليزية للحساب
            let month1Val = convertArabicToEnglishNumber(month1Input.value);
            let month2Val = convertArabicToEnglishNumber(month2Input.value);
            
            const month1 = parseInt(month1Val) || 0;
            const month2 = parseInt(month2Val) || 0;
            let monthlyAverage = '';
            
            if (month1 > 0 || month2 > 0) {
                monthlyAverage = Math.round((month1 + month2) / 2);
            }
            
            monthlySpan.textContent = monthlyAverage;
            
            if (monthlyAverage >= 70) {
                monthlySpan.className = 'grade-value grade-excellent ' + term + '-monthly';
            } else if (monthlyAverage >= 50) {
                monthlySpan.className = 'grade-value grade-average ' + term + '-monthly';
            } else if (monthlyAverage !== '') {
                monthlySpan.className = 'grade-value grade-fail ' + term + '-monthly';
            } else {
                monthlySpan.className = 'grade-value grade-average ' + term + '-monthly';
            }
        }
        
        // حفظ درجات الطالب - الإصدار المعدل
        async function saveStudentGrades(studentId) {
            // التحقق من الصلاحيات
            if (currentUser.type === 'teacher') {
                // للمدرس، التحقق من أنه يحاول تعديل مادته فقط
                const student = students.find(s => (s.id == studentId) || (s.tempId == studentId));
                if (!student) {
                    showNotification('error', 'لم يتم العثور على الطالب');
                    return;
                }
                
                let hasUnauthorizedChanges = false;
                const rows = document.querySelectorAll('#gradesTable tbody tr');
                
                rows.forEach(row => {
                    const subject = row.getAttribute('data-subject');
                    if (subject !== currentUser.subject) {
                        // التحقق إذا كان المدرس حاول تعديل مادة ليست مادته
                        const inputs = row.querySelectorAll('.grade-input');
                        inputs.forEach(input => {
                            if (input.value !== input.defaultValue) {
                                hasUnauthorizedChanges = true;
                            }
                        });
                    }
                });
                
                if (hasUnauthorizedChanges) {
                    showNotification('error', 'ليس لديك صلاحية لتعديل مواد أخرى');
                    return;
                }
            }
            
            const student = students.find(s => (s.id == studentId) || (s.tempId == studentId));
            if (!student) {
                showNotification('error', 'لم يتم العثور على الطالب');
                return;
            }
            
            const rows = document.querySelectorAll('#gradesTable tbody tr');
            let changesMade = false;
            let changedSubjects = [];
            
            rows.forEach(row => {
                const subject = row.getAttribute('data-subject');
                
                if (!student.grades) student.grades = {};
                if (!student.grades[subject]) {
                    student.grades[subject] = {
                        firstTerm: { month1: '', month2: '', midterm: '' },
                        secondTerm: { month1: '', month2: '', final: '' },
                        finalAverage: ''
                    };
                }
                
                // تحويل الأرقام العربية إلى إنجليزية قبل الحفظ
                const month1First = convertArabicToEnglishNumber(row.querySelector('.first-month1').value);
                const month2First = convertArabicToEnglishNumber(row.querySelector('.first-month2').value);
                const midterm = convertArabicToEnglishNumber(row.querySelector('.first-midterm').value);
                const month1Second = convertArabicToEnglishNumber(row.querySelector('.second-month1').value);
                const month2Second = convertArabicToEnglishNumber(row.querySelector('.second-month2').value);
                const final = convertArabicToEnglishNumber(row.querySelector('.second-final').value);
                const finalAverage = convertArabicToEnglishNumber(row.querySelector('.final-average-input').value);
                
                // تسجيل التغييرات - فقط إذا كان هناك تغيير حقيقي
                const oldMonth1First = student.grades[subject].firstTerm.month1 || '';
                const oldMonth2First = student.grades[subject].firstTerm.month2 || '';
                const oldMidterm = student.grades[subject].firstTerm.midterm || '';
                const oldMonth1Second = student.grades[subject].secondTerm.month1 || '';
                const oldMonth2Second = student.grades[subject].secondTerm.month2 || '';
                const oldFinal = student.grades[subject].secondTerm.final || '';
                const oldFinalAverage = student.grades[subject].finalAverage || '';
                
                const newMonth1First = month1First || '';
                const newMonth2First = month2First || '';
                const newMidterm = midterm || '';
                const newMonth1Second = month1Second || '';
                const newMonth2Second = month2Second || '';
                const newFinal = final || '';
                const newFinalAverage = finalAverage || '';
                
                // التحقق إذا كان هناك تغيير فعلي في هذه المادة
                const hasChanged = 
                    oldMonth1First !== newMonth1First || 
                    oldMonth2First !== newMonth2First || 
                    oldMidterm !== newMidterm || 
                    oldMonth1Second !== newMonth1Second || 
                    oldMonth2Second !== newMonth2Second || 
                    oldFinal !== newFinal || 
                    oldFinalAverage !== newFinalAverage;
                
                if (hasChanged) {
                    changesMade = true;
                    
                    // فقط إذا كان المدرس يغير مادته، أو المدير يغير أي مادة
                    const canChange = currentUser.type === 'admin' || 
                                     (currentUser.type === 'teacher' && currentUser.subject === subject);
                    
                    if (canChange) {
                        changedSubjects.push(subject);
                        
                        // تسجيل تفاصيل التغيير
                        let changeDetails = [];
                        if (oldMonth1First !== newMonth1First) changeDetails.push(`الشهر1 الفصل1: ${oldMonth1First || 'فارغ'} → ${newMonth1First || 'فارغ'}`);
                        if (oldMonth2First !== newMonth2First) changeDetails.push(`الشهر2 الفصل1: ${oldMonth2First || 'فارغ'} → ${newMonth2First || 'فارغ'}`);
                        if (oldMidterm !== newMidterm) changeDetails.push(`نصف السنة: ${oldMidterm || 'فارغ'} → ${newMidterm || 'فارغ'}`);
                        if (oldMonth1Second !== newMonth1Second) changeDetails.push(`الشهر1 الفصل2: ${oldMonth1Second || 'فارغ'} → ${newMonth1Second || 'فارغ'}`);
                        if (oldMonth2Second !== newMonth2Second) changeDetails.push(`الشهر2 الفصل2: ${oldMonth2Second || 'فارغ'} → ${newMonth2Second || 'فارغ'}`);
                        if (oldFinal !== newFinal) changeDetails.push(`نهاية السنة: ${oldFinal || 'فارغ'} → ${newFinal || 'فارغ'}`);
                        if (oldFinalAverage !== newFinalAverage) changeDetails.push(`المعدل النهائي: ${oldFinalAverage || 'فارغ'} → ${newFinalAverage || 'فارغ'}`);
                        
                        // إضافة إشعار للمدير - لكل مادة تم تغييرها
                        addNotification(
                            currentUser.name,
                            currentUser.subject || currentUser.role,
                            student.name,
                            'update',
                            `درجات سابقة في ${subject}`,
                            `درجات جديدة في ${subject}`,
                            `تغيير درجات ${student.name} في ${subject}: ${changeDetails.join(', ')}`
                        );
                    }
                }
                
                // تحديث القيم في كل الأحوال (لكن الإشعار فقط للمادة التي تم تغييرها)
                student.grades[subject].firstTerm.month1 = newMonth1First;
                student.grades[subject].firstTerm.month2 = newMonth2First;
                student.grades[subject].firstTerm.midterm = newMidterm;
                
                student.grades[subject].secondTerm.month1 = newMonth1Second;
                student.grades[subject].secondTerm.month2 = newMonth2Second;
                student.grades[subject].secondTerm.final = newFinal;
                
                student.grades[subject].finalAverage = newFinalAverage;
            });
            
            // تحديث وقت التعديل المحلي
            student.localUpdateTime = Date.now();
            
            // حفظ محلياً فوراً
            saveToLocalStorage();
            
            // تسجيل التعديل محلياً
            const actualStudentId = student.id || student.tempId;
            registerLocalChange(actualStudentId, 'updateGrades', {
                grades: student.grades
            });
            
            if (changesMade) {
                showNotification('success', `تم حفظ الدرجات محلياً (${changedSubjects.length} مادة تم تحديثها)`);
                
                // تحديث الإحصائيات
                updateStats();
                updateNotificationsStats();
                updatePendingSyncList();
                
                // عرض خيار رفع التعديلات
                if (isOnline) {
                    setTimeout(() => {
                        showConfirm('هل تريد رفع التعديلات إلى السيرفر الآن؟', function() {
                            uploadLocalChangesToServer();
                        });
                    }, 1000);
                }
            } else {
                showNotification('info', 'لم يتم إجراء أي تغييرات على الدرجات');
            }
        }
        
        // ========== وضع الموبايل ==========
        let isMobileMode = false;
        
        function toggleMobileMode() {
            isMobileMode = !isMobileMode;
            
            if (isMobileMode) {
                document.body.classList.add('mobile-mode-enabled');
                document.getElementById('mobileModeHeaderBtn').innerHTML = '<i class="fas fa-desktop"></i> وضع الكمبيوتر';
                showNotification('success', 'تم تفعيل وضع الموبايل', 2000);
            } else {
                document.body.classList.remove('mobile-mode-enabled');
                document.getElementById('mobileModeHeaderBtn').innerHTML = '<i class="fas fa-mobile-alt"></i> وضع الموبايل';
                showNotification('success', 'تم تفعيل وضع الكمبيوتر', 2000);
            }
            
            // حفظ إعدادات وضع الموبايل
            localStorage.setItem('mobileMode', isMobileMode ? 'enabled' : 'disabled');
        }
        
        // ========== معالجات الأحداث ==========
        
        function setupEventListeners() {
            // تسجيل الدخول
            document.getElementById('loginBtn').addEventListener('click', login);
            document.getElementById('loginCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // البحث عن طالب
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            
            // عرض جميع الطلاب
            document.getElementById('showAllStudents').addEventListener('click', function() {
                document.getElementById('gradesSection').style.display = 'none';
                document.getElementById('addStudentSection').style.display = 'none';
                document.getElementById('bulkImportSection').style.display = 'none';
                document.getElementById('studentsSection').style.display = 'block';
                displayAllStudents();
            });
            
            // التصفية الفورية عند تغيير الصف أو الشعبة
            document.getElementById('filterClass').addEventListener('change', function() {
                displayAllStudents();
            });
            
            document.getElementById('filterDivision').addEventListener('change', function() {
                displayAllStudents();
            });
            
            // رفع البيانات إلى السيرفر
            document.getElementById('uploadToServerBtn').addEventListener('click', uploadToServer);
            
            // استيراد البيانات من السيرفر
            document.getElementById('downloadFromServerBtn').addEventListener('click', downloadFromServer);
            
            // وضع الموبايل في الهيدر
            document.getElementById('mobileModeHeaderBtn').addEventListener('click', toggleMobileMode);
            
            // الإشعارات في الهيدر
            document.getElementById('notificationsHeaderBtn').addEventListener('click', openNotificationsModal);
            
            // إدارة الأكواد
            document.getElementById('manageCodesBtn').addEventListener('click', function() {
                if (currentUser && currentUser.type === 'admin') {
                    document.getElementById('manageCodesModal').classList.add('show');
                    displayCurrentCodes();
                }
            });
            
            document.getElementById('changeCodeBtn').addEventListener('click', changeSubjectCode);
            document.getElementById('resetAllCodesBtn').addEventListener('click', resetAllCodes);
            document.getElementById('printCodesBtn').addEventListener('click', printCodes);
            document.getElementById('closeManageCodesBtn').addEventListener('click', function() {
                document.getElementById('manageCodesModal').classList.remove('show');
            });
            
            // عرض الإشعارات
            document.getElementById('viewNotificationsBtn').addEventListener('click', openNotificationsModal);
            
            // تصفية الإشعارات
            document.getElementById('filterNotificationsBtn').addEventListener('click', function() {
                const filterSubject = document.getElementById('filterNotificationSubject').value;
                const filterTeacher = document.getElementById('filterNotificationTeacher').value;
                const filterStatus = document.getElementById('filterNotificationStatus').value;
                displayNotifications(filterSubject, filterTeacher, filterStatus);
            });
            
            // تعيين الكل كمقروء
            document.getElementById('markAllReadBtn').addEventListener('click', markAllNotificationsAsRead);
            
            // حذف جميع الإشعارات
            document.getElementById('clearAllNotificationsBtn').addEventListener('click', clearAllNotifications);
            
            // إغلاق نافذة الإشعارات
            document.getElementById('closeNotificationsBtn').addEventListener('click', function() {
                document.getElementById('notificationsModal').classList.remove('show');
            });
            
            // استيراد أسماء دفعة واحدة
            document.getElementById('bulkImportBtn').addEventListener('click', function() {
                // التحقق من الصلاحيات
                if (currentUser.type === 'teacher') {
                    showNotification('error', 'ليس لديك صلاحية لاستيراد الطلاب');
                    return;
                }
                showBulkImport();
            });
            
            // إغلاق قسم الاستيراد
            document.getElementById('closeBulkImport').addEventListener('click', function() {
                document.getElementById('bulkImportSection').style.display = 'none';
                document.getElementById('studentsSection').style.display = 'block';
            });
            
            // تحديث عداد الأسماء عند الكتابة
            document.getElementById('bulkNames').addEventListener('input', function() {
                updateNamesCounter();
            });
            
            // معاينة الأسماء
            document.getElementById('previewBulkNames').addEventListener('click', function() {
                previewBulkNames();
            });
            
            // تقديم نموذج استيراد الأسماء
            document.getElementById('bulkImportForm').addEventListener('submit', function(e) {
                e.preventDefault();
                importBulkNames();
            });
            
            // إضافة طالب جديد
            document.getElementById('addStudentBtn').addEventListener('click', function() {
                // التحقق من الصلاحيات
                if (currentUser.type === 'teacher') {
                    showNotification('error', 'ليس لديك صلاحية لإضافة طلاب');
                    return;
                }
                document.getElementById('studentsSection').style.display = 'none';
                document.getElementById('gradesSection').style.display = 'none';
                document.getElementById('bulkImportSection').style.display = 'none';
                document.getElementById('addStudentSection').style.display = 'block';
                document.getElementById('studentNameInput').focus();
            });
            
            // إلغاء إضافة طالب
            document.getElementById('cancelAddStudent').addEventListener('click', function() {
                document.getElementById('addStudentSection').style.display = 'none';
                document.getElementById('studentsSection').style.display = 'block';
                document.getElementById('addStudentForm').reset();
            });
            
            // إغلاق عرض الدرجات
            document.getElementById('closeGradesBtn').addEventListener('click', function() {
                document.getElementById('gradesSection').style.display = 'none';
                document.getElementById('studentsSection').style.display = 'block';
            });
            
            // حفظ الدرجات
            document.getElementById('saveGradesBtn').addEventListener('click', async function() {
                await saveStudentGrades(currentStudentId);
            });
            
            // زر طباعة الدرجات
            document.getElementById('printGradesBtn').addEventListener('click', function() {
                printStudentGrades();
            });
            
            // تقديم نموذج إضافة طالب
            document.getElementById('addStudentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                // التحقق من الصلاحيات
                if (currentUser.type === 'teacher') {
                    showNotification('error', 'ليس لديك صلاحية لإضافة طلاب');
                    return;
                }
                addNewStudent();
            });
            
            // تأكيد الحذف
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                deleteStudent();
            });
            
            // إلغاء الحذف
            document.getElementById('cancelDeleteBtn').addEventListener('click', function() {
                hideDeleteModal();
            });
            
            // نافذة التأكيد المخصصة
            document.getElementById('confirmCancelBtn').addEventListener('click', function() {
                closeConfirm();
            });
            
            document.getElementById('confirmOkBtn').addEventListener('click', function() {
                if (confirmCallback) {
                    confirmCallback();
                }
                closeConfirm();
            });
            
            // زر النسخ الاحتياطي
            document.getElementById('backupBtn').addEventListener('click', function() {
                // التحقق من الصلاحيات
                if (currentUser.type === 'teacher') {
                    showNotification('error', 'ليس لديك صلاحية للنسخ الاحتياطي');
                    return;
                }
                document.getElementById('backupModal').classList.add('show');
            });
            
            // إغلاق نافذة النسخ الاحتياطي
            document.getElementById('closeBackupBtn').addEventListener('click', function() {
                document.getElementById('backupModal').classList.remove('show');
            });
            
            // خيارات النسخ الاحتياطي
            document.getElementById('backupLocalOption').addEventListener('click', function() {
                createLocalBackup();
                document.getElementById('backupModal').classList.remove('show');
            });
            
            document.getElementById('restoreLocalOption').addEventListener('click', function() {
                restoreFromLocalFile();
                document.getElementById('backupModal').classList.remove('show');
            });
            
            document.getElementById('exportExcelOption').addEventListener('click', function() {
                exportToExcel();
                document.getElementById('backupModal').classList.remove('show');
            });
            
            // حذف كافة البيانات
            document.getElementById('deleteAllBtn').addEventListener('click', function() {
                // التحقق من الصلاحيات
                if (currentUser.type === 'teacher') {
                    showNotification('error', 'ليس لديك صلاحية لحذف جميع البيانات');
                    return;
                }
                deleteAllData();
            });
            
            // تأكيد حذف كافة البيانات
            document.getElementById('confirmDeleteAllBtn').addEventListener('click', function() {
                confirmDeleteAllData();
            });
            
            // إلغاء حذف كافة البيانات
            document.getElementById('cancelDeleteAllBtn').addEventListener('click', function() {
                document.getElementById('deleteAllModal').classList.remove('show');
            });
            
            // تسجيل الخروج
            document.querySelector('.user-info').addEventListener('click', logout);
        }
        
        // ========== الوظائف الرئيسية ==========
        
        // معالجة البحث
        function handleSearch(e) {
            const searchTerm = e.target.value.trim().toLowerCase();
            const resultsContainer = document.getElementById('searchResults');
            
            if (searchTerm.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredStudents = students.filter(student => 
                student.name.toLowerCase().includes(searchTerm) ||
                student.division.toLowerCase().includes(searchTerm) ||
                student.class.toString().includes(searchTerm)
            );
            
            displaySearchResults(filteredStudents, searchTerm);
        }
        
        // عرض نتائج البحث
        function displaySearchResults(filteredStudents, searchTerm) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (filteredStudents.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">لم يتم العثور على طلاب مطابقين للبحث</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            let resultsHTML = '';
            filteredStudents.forEach(student => {
                let classText = '';
                if (student.class === '4') classText = 'الرابع العلمي';
                else if (student.class === '5') classText = 'الخامس العلمي';
                else if (student.class === '6') classText = 'السادس العلمي';
                
                resultsHTML += `
                    <div class="search-result-item" data-id="${student.id || student.tempId}">
                        <i class="fas fa-user-graduate"></i>
                        <div>
                            <h4>${student.name}</h4>
                            <p>الصف: ${classText} - الشعبة: ${student.division}</p>
                        </div>
                    </div>
                `;
            });
            
            resultsContainer.innerHTML = resultsHTML;
            resultsContainer.style.display = 'block';
            
            document.querySelectorAll('.search-result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const student = students.find(s => (s.id == studentId) || (s.tempId == studentId));
                    if (student) {
                        showStudentGrades(student.id || student.tempId);
                        document.getElementById('searchInput').value = '';
                        resultsContainer.style.display = 'none';
                    }
                });
            });
        }
        
        // إضافة طالب جديد
        async function addNewStudent() {
            const name = document.getElementById('studentNameInput').value.trim();
            const studentClass = document.getElementById('studentClassInput').value;
            const division = document.getElementById('studentDivisionInput').value;
            const parentPhone = document.getElementById('parentPhoneInput').value.trim();
            
            if (!name || !studentClass || !division || !parentPhone) {
                showNotification('warning', 'يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // إنشاء درجات فارغة للطالب
            const defaultGrades = {};
            subjectsByClass[studentClass].forEach(subject => {
                defaultGrades[subject] = {
                    firstTerm: {
                        month1: '',
                        month2: '',
                        midterm: ''
                    },
                    secondTerm: {
                        month1: '',
                        month2: '',
                        final: ''
                    },
                    finalAverage: ''
                };
            });
            
            // إنشاء tempId مؤقت للطالب الجديد
            const tempId = 'temp_' + Date.now();
            
            // إنشاء كائن الطالب
            const newStudent = {
                tempId: tempId,
                name,
                class: studentClass,
                division,
                parentPhone,
                grades: defaultGrades,
                createdAt: new Date().toISOString(),
                localUpdateTime: Date.now()
            };
            
            // إضافة الطالب إلى المصفوفة المحلية فوراً
            students.push(newStudent);
            
            // حفظ محلياً فوراً
            saveToLocalStorage();
            
            // تسجيل التعديل محلياً
            registerLocalChange(tempId, 'addStudent', newStudent);
            
            // إضافة إشعار للمدير
            addNotification(
                currentUser.name,
                currentUser.role,
                name,
                'add',
                null,
                null,
                `تم إضافة طالب جديد: ${name} في الصف ${studentClass} - الشعبة ${division} - هاتف ولي الأمر: ${parentPhone}`
            );
            
            // تحديث العرض
            updateStats();
            updateNotificationsStats();
            updatePendingSyncList();
            document.getElementById('addStudentSection').style.display = 'none';
            document.getElementById('studentsSection').style.display = 'block';
            displayAllStudents();
            
            showNotification('info', `تم إضافة الطالب ${name} محلياً`);
            
            // عرض خيار رفع الطالب الجديد
            if (isOnline) {
                setTimeout(() => {
                    showConfirm('هل تريد رفع الطالب الجديد إلى السيرفر الآن؟', function() {
                        uploadLocalChangesToServer();
                    });
                }, 1000);
            }
            
            // إعادة تعيين النموذج
            document.getElementById('addStudentForm').reset();
        }
        
        // عرض نافذة تأكيد الحذف
        function showDeleteModal(studentId, studentName) {
            // التحقق من الصلاحيات
            if (currentUser.type === 'teacher') {
                showNotification('error', 'ليس لديك صلاحية لحذف الطلاب');
                return;
            }
            
            studentToDeleteId = studentId;
            document.getElementById('deleteConfirmText').textContent = `هل أنت متأكد من رغبتك في حذف الطالب "${studentName}"؟`;
            document.getElementById('deleteConfirmModal').classList.add('show');
        }
        
        // إخفاء نافذة تأكيد الحذف
        function hideDeleteModal() {
            document.getElementById('deleteConfirmModal').classList.remove('show');
            studentToDeleteId = null;
        }
        
        // حذف الطالب
        async function deleteStudent() {
            if (!studentToDeleteId) return;
            
            const studentIndex = students.findIndex(s => (s.id == studentToDeleteId) || (s.tempId == studentToDeleteId));
            
            if (studentIndex !== -1) {
                const student = students[studentIndex];
                const studentName = student.name;
                const studentFirebaseId = student.id;
                
                // إضافة إشعار للمدير
                addNotification(
                    currentUser.name,
                    currentUser.role,
                    studentName,
                    'delete',
                    null,
                    null,
                    `تم حذف الطالب: ${studentName} من الصف ${student.class} - الشعبة ${student.division}`
                );
                
                // حذف من المصفوفة المحلية
                students.splice(studentIndex, 1);
                
                // حفظ محلياً فوراً
                saveToLocalStorage();
                
                // تسجيل الحذف محلياً
                if (studentFirebaseId && !studentFirebaseId.startsWith('temp_')) {
                    // تسجيل الحذف للتأكد من أنه يتم حذفه من Firebase عند الرفع
                    registerLocalChange(studentFirebaseId, 'deleteStudent', {
                        id: studentFirebaseId,
                        name: studentName
                    });
                }
                
                showNotification('success', `تم حذف الطالب "${studentName}" محلياً`);
                
                // تحديث الإحصائيات
                updateStats();
                updateNotificationsStats();
                updatePendingSyncList();
                
                // إغلاق نافذة التأكيد
                hideDeleteModal();
                
                // إعادة عرض قائمة الطلاب
                displayAllStudents();
                
                // عرض خيار رفع التعديل
                if (isOnline) {
                    setTimeout(() => {
                        showConfirm('هل تريد رفع تغيير الحذف إلى السيرفر الآن؟', function() {
                            uploadLocalChangesToServer();
                        });
                    }, 1000);
                }
            } else {
                showNotification('error', 'لم يتم العثور على الطالب');
                hideDeleteModal();
            }
        }
        
        // طباعة درجات الطالب
        function printStudentGrades() {
            // حفظ الدرجات أولاً
            saveStudentGrades(currentStudentId);
            
            const printWindow = window.open('', '_blank');
            const student = students.find(s => (s.id == currentStudentId) || (s.tempId == currentStudentId));
            
            if (!student) {
                showNotification('error', 'لم يتم العثور على بيانات الطالب للطباعة');
                return;
            }
            
            let classText = '';
            if (student.class === '4') classText = 'الرابع العلمي';
            else if (student.class === '5') classText = 'الخامس العلمي';
            else if (student.class === '6') classText = 'السادس العلمي';
            
            let printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>كشف درجات الطالب</title>
                    <style>
                        body { font-family: 'Cairo', sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .header h1 { color: #4169E1; margin-bottom: 5px; }
                        .header h2 { color: #333; margin-bottom: 20px; }
                        .student-info { margin-bottom: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 5px; }
                        .student-info p { margin: 5px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
                        th { background-color: #f0f7ff; color: #4169E1; }
                        .subject-header { background-color: #e6f0ff; font-weight: bold; }
                        .grade-excellent { background-color: #e8f5e9; }
                        .grade-average { background-color: #ffffff; }
                        .grade-fail { background-color: #ffebee; }
                        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; }
                        @media print {
                            body { margin: 0; padding: 10px; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>إعدادية المجر الكبير للبنين</h1>
                        <h2>كشف درجات الطالب</h2>
                    </div>
                    
                    <div class="student-info">
                        <p><strong>اسم الطالب:</strong> ${student.name}</p>
                        <p><strong>الصف:</strong> ${classText}</p>
                        <p><strong>الشعبة:</strong> ${student.division}</p>
                        <p><strong>رقم هاتف ولي الأمر:</strong> ${student.parentPhone}</p>
                        <p><strong>التاريخ:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th rowspan="2">المادة</th>
                                <th colspan="4">الفصل الأول</th>
                                <th colspan="4">الفصل الثاني</th>
                                <th rowspan="2">المعدل النهائي</th>
                            </tr>
                            <tr>
                                <th>امتحان الشهر الأول</th>
                                <th>امتحان الشهر الثاني</th>
                                <th>السعي</th>
                                <th>نصف السنة</th>
                                <th>امتحان الشهر الأول</th>
                                <th>امتحان الشهر الثاني</th>
                                <th>السعي</th>
                                <th>اختبار نهاية السنة</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // إضافة بيانات المواد
            const subjects = subjectsByClass[student.class] || [];
            subjects.forEach(subject => {
                const subjectGrades = student.grades[subject] || {
                    firstTerm: { month1: '', month2: '', midterm: '' },
                    secondTerm: { month1: '', month2: '', final: '' },
                    finalAverage: ''
                };
                
                // حساب السعي
                const month1First = subjectGrades.firstTerm.month1 || '';
                const month2First = subjectGrades.firstTerm.month2 || '';
                let firstTermMonthly = '';
                
                if (month1First && month2First) {
                    const num1 = parseInt(convertArabicToEnglishNumber(month1First));
                    const num2 = parseInt(convertArabicToEnglishNumber(month2First));
                    if (!isNaN(num1) && !isNaN(num2)) {
                        firstTermMonthly = Math.round((num1 + num2) / 2);
                    }
                }
                
                const month1Second = subjectGrades.secondTerm.month1 || '';
                const month2Second = subjectGrades.secondTerm.month2 || '';
                let secondTermMonthly = '';
                
                if (month1Second && month2Second) {
                    const num1 = parseInt(convertArabicToEnglishNumber(month1Second));
                    const num2 = parseInt(convertArabicToEnglishNumber(month2Second));
                    if (!isNaN(num1) && !isNaN(num2)) {
                        secondTermMonthly = Math.round((num1 + num2) / 2);
                    }
                }
                
                const finalAverage = subjectGrades.finalAverage || '';
                
                let finalGradeClass = '';
                if (finalAverage) {
                    const numGrade = parseInt(convertArabicToEnglishNumber(finalAverage));
                    if (!isNaN(numGrade)) {
                        if (numGrade >= 70) finalGradeClass = 'grade-excellent';
                        else if (numGrade >= 50) finalGradeClass = 'grade-average';
                        else finalGradeClass = 'grade-fail';
                    }
                }
                
                printContent += `
                    <tr>
                        <td class="subject-header">${subject}</td>
                        <td>${month1First || ''}</td>
                        <td>${month2First || ''}</td>
                        <td>${firstTermMonthly || ''}</td>
                        <td>${subjectGrades.firstTerm.midterm || ''}</td>
                        <td>${month1Second || ''}</td>
                        <td>${month2Second || ''}</td>
                        <td>${secondTermMonthly || ''}</td>
                        <td>${subjectGrades.secondTerm.final || ''}</td>
                        <td class="${finalGradeClass}">${finalAverage || ''}</td>
                    </tr>
                `;
            });
            
            printContent += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p class="no-print"><button onclick="window.print()">طباعة</button> <button onclick="window.close()">إغلاق</button></p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            showNotification('success', 'تم فتح نافذة الطباعة');
        }
        
        // تحديث الإحصائيات
        function updateStats() {
            // إجمالي الطلاب
            document.getElementById('totalStudents').textContent = students.length;
            
            // عدد الصفوف
            const uniqueClasses = [...new Set(students.map(student => student.class))];
            document.getElementById('totalClasses').textContent = uniqueClasses.length;
        }
        
        // ========== تهيئة الصفحة ==========
        document.addEventListener('DOMContentLoaded', function() {
            // إعداد معالج الأحداث
            setupEventListeners();
            
            // التحقق من إعدادات وضع الموبايل المحفوظة
            const savedMobileMode = localStorage.getItem('mobileMode');
            if (savedMobileMode === 'enabled') {
                // تفعيل وضع الموبايل تلقائياً
                setTimeout(() => {
                    if (document.getElementById('mobileModeHeaderBtn')) {
                        document.getElementById('mobileModeHeaderBtn').click();
                    }
                }, 500);
            }
            
            // التركيز على حقل إدخال الكود
            document.getElementById('loginCode').focus();
            
            // مراقبة حالة الاتصال
            setInterval(() => {
                updateConnectionStatus();
            }, 10000);
            
            // مراقبة اتصال/انفصال الإنترنت
            window.addEventListener('online', async () => {
                showNotification('success', 'تم الاتصال بالإنترنت - جاهز للرفع');
                await updateConnectionStatus();
            });
            
            window.addEventListener('offline', () => {
                showNotification('warning', 'فقدت الاتصال بالإنترنت');
                updateConnectionStatus();
            });
        });
        
        // دالة للإبلاغ عن الأخطاء
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('حدث خطأ:', message, 'في:', source, 'السطر:', lineno);
            return true;
        };
    </script>
</body>
</html>
